<!doctype html><html lang=es class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Curso end-to-end para construir un portafolio ML/MLOps profesional desde cero"><meta name=author content=DuqueOM><link href=https://duqueom.github.io/Guia_MLOps/docs/14_FASTAPI/ rel=canonical><link href=../13_DOCKER/ rel=prev><link href=../15_STREAMLIT/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>14 â€” FastAPI - GuÃ­a MLOps â€” Portfolio Edition v2</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=deep-purple> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#14-fastapi-para-produccion class=md-skip> Saltar a contenido </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Cabecera> <a href=../.. title="GuÃ­a MLOps â€” Portfolio Edition v2" class="md-header__button md-logo" aria-label="GuÃ­a MLOps â€” Portfolio Edition v2" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> GuÃ­a MLOps â€” Portfolio Edition v2 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 14 â€” FastAPI </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=deep-purple aria-label="Cambiar a modo oscuro" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=deep-purple aria-label="Cambiar a modo claro" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Cambiar a modo claro" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=BÃºsqueda placeholder=BÃºsqueda autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Buscar> <button type=reset class="md-search__icon md-icon" title=Limpiar aria-label=Limpiar tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Inicializando bÃºsqueda </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/DuqueOM/Guia_MLOps title="Ir al repositorio" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> Guia_MLOps </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=PestaÃ±as data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../ class=md-tabs__link> Inicio </a> </li> <li class=md-tabs__item> <a href=../00_INDICE/ class=md-tabs__link> Ãndice Principal </a> </li> <li class=md-tabs__item> <a href=../SYLLABUS/ class=md-tabs__link> Syllabus </a> </li> <li class=md-tabs__item> <a href=../MAPA_PORTAFOLIO_1TO1/ class=md-tabs__link> Mapa 1:1 Portafolio </a> </li> <li class=md-tabs__item> <a href=../PLAN_ESTUDIOS/ class=md-tabs__link> Plan de Estudios </a> </li> <li class=md-tabs__item> <a href=../01_PYTHON_MODERNO/ class=md-tabs__link> Fase 1 - Fundamentos </a> </li> <li class=md-tabs__item> <a href=../07_SKLEARN_PIPELINES/ class=md-tabs__link> Fase 2 - ML Engineering </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../11_TESTING_ML/ class=md-tabs__link> Fase 3 - MLOps Core </a> </li> <li class=md-tabs__item> <a href=../17_DESPLIEGUE/ class=md-tabs__link> Fase 4 - ProducciÃ³n </a> </li> <li class=md-tabs__item> <a href=../19_DOCUMENTACION/ class=md-tabs__link> Fase 5 - Senior/Staff </a> </li> <li class=md-tabs__item> <a href=../apoyo/ class=md-tabs__link> Material de Apoyo </a> </li> <li class=md-tabs__item> <a href=../study_tools/ class=md-tabs__link> Herramientas de Estudio </a> </li> <li class=md-tabs__item> <a href=../../exams/EXAM_01_SETUP/ class=md-tabs__link> ExÃ¡menes </a> </li> <li class=md-tabs__item> <a href=../SIMULACRO_ENTREVISTA_JUNIOR/ class=md-tabs__link> Simulacros de Entrevista </a> </li> <li class=md-tabs__item> <a href=../../notebooks/labs/LAB_01_DOCKER_DEBUG/ class=md-tabs__link> Laboratorios </a> </li> <li class=md-tabs__item> <a href=../templates/ class=md-tabs__link> Plantillas </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=NavegaciÃ³n data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="GuÃ­a MLOps â€” Portfolio Edition v2" class="md-nav__button md-logo" aria-label="GuÃ­a MLOps â€” Portfolio Edition v2" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> GuÃ­a MLOps â€” Portfolio Edition v2 </label> <div class=md-nav__source> <a href=https://github.com/DuqueOM/Guia_MLOps title="Ir al repositorio" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> Guia_MLOps </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Inicio </span> </a> </li> <li class=md-nav__item> <a href=../00_INDICE/ class=md-nav__link> <span class=md-ellipsis> Ãndice Principal </span> </a> </li> <li class=md-nav__item> <a href=../SYLLABUS/ class=md-nav__link> <span class=md-ellipsis> Syllabus </span> </a> </li> <li class=md-nav__item> <a href=../MAPA_PORTAFOLIO_1TO1/ class=md-nav__link> <span class=md-ellipsis> Mapa 1:1 Portafolio </span> </a> </li> <li class=md-nav__item> <a href=../PLAN_ESTUDIOS/ class=md-nav__link> <span class=md-ellipsis> Plan de Estudios </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Fase 1 - Fundamentos </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Fase 1 - Fundamentos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01_PYTHON_MODERNO/ class=md-nav__link> <span class=md-ellipsis> 01 â€” Python Moderno </span> </a> </li> <li class=md-nav__item> <a href=../02_DISENO_SISTEMAS/ class=md-nav__link> <span class=md-ellipsis> 02 â€” DiseÃ±o de Sistemas </span> </a> </li> <li class=md-nav__item> <a href=../03_ESTRUCTURA_PROYECTO/ class=md-nav__link> <span class=md-ellipsis> 03 â€” Estructura de Proyecto </span> </a> </li> <li class=md-nav__item> <a href=../04_ENTORNOS/ class=md-nav__link> <span class=md-ellipsis> 04 â€” Entornos </span> </a> </li> <li class=md-nav__item> <a href=../05_GIT_PROFESIONAL/ class=md-nav__link> <span class=md-ellipsis> 05 â€” Git Profesional </span> </a> </li> <li class=md-nav__item> <a href=../06_VERSIONADO_DATOS/ class=md-nav__link> <span class=md-ellipsis> 06 â€” Versionado de Datos </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Fase 2 - ML Engineering </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Fase 2 - ML Engineering </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../07_SKLEARN_PIPELINES/ class=md-nav__link> <span class=md-ellipsis> 07 â€” sklearn Pipelines </span> </a> </li> <li class=md-nav__item> <a href=../08_INGENIERIA_FEATURES/ class=md-nav__link> <span class=md-ellipsis> 08 â€” IngenierÃ­a de Features </span> </a> </li> <li class=md-nav__item> <a href=../09_TRAINING_PROFESIONAL/ class=md-nav__link> <span class=md-ellipsis> 09 â€” Training Profesional </span> </a> </li> <li class=md-nav__item> <a href=../10_EXPERIMENT_TRACKING/ class=md-nav__link> <span class=md-ellipsis> 10 â€” Experiment Tracking </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8 checked> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Fase 3 - MLOps Core </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=true> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Fase 3 - MLOps Core </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../11_TESTING_ML/ class=md-nav__link> <span class=md-ellipsis> 11 â€” Testing ML </span> </a> </li> <li class=md-nav__item> <a href=../12_CI_CD/ class=md-nav__link> <span class=md-ellipsis> 12 â€” CI/CD </span> </a> </li> <li class=md-nav__item> <a href=../13_DOCKER/ class=md-nav__link> <span class=md-ellipsis> 13 â€” Docker </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 14 â€” FastAPI </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 14 â€” FastAPI </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Tabla de contenidos </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#00-prerrequisitos class=md-nav__link> <span class=md-ellipsis> 0.0 Prerrequisitos </span> </a> </li> <li class=md-nav__item> <a href=#01-protocolo-e-como-estudiar-este-modulo class=md-nav__link> <span class=md-ellipsis> 0.1 ğŸ§  Protocolo E: CÃ³mo estudiar este mÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#02-entregables-verificables-minimo-viable class=md-nav__link> <span class=md-ellipsis> 0.2 âœ… Entregables verificables (mÃ­nimo viable) </span> </a> </li> <li class=md-nav__item> <a href=#03-puente-teoria-codigo-portafolio class=md-nav__link> <span class=md-ellipsis> 0.3 ğŸ§© Puente teorÃ­a â†” cÃ³digo (Portafolio) </span> </a> </li> <li class=md-nav__item> <a href=#objetivo-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ¯ Objetivo del MÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#contenido class=md-nav__link> <span class=md-ellipsis> ğŸ“‹ Contenido </span> </a> <nav class=md-nav aria-label="ğŸ“‹ Contenido"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mapa-mental-de-conceptos-fastapi-para-ml class=md-nav__link> <span class=md-ellipsis> ğŸ§  Mapa Mental de Conceptos: FastAPI para ML </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-puente-api-minima class=md-nav__link> <span class=md-ellipsis> ğŸ’» Ejercicio Puente: API MÃ­nima </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-puente-apis-ml class=md-nav__link> <span class=md-ellipsis> ğŸ’» Ejercicio Puente: APIs ML </span> </a> </li> <li class=md-nav__item> <a href=#practica-del-portafolio-fastapi-en-bankchurn class=md-nav__link> <span class=md-ellipsis> ğŸ› ï¸ PrÃ¡ctica del Portafolio: FastAPI en BankChurn </span> </a> </li> <li class=md-nav__item> <a href=#checkpoint-de-conocimiento class=md-nav__link> <span class=md-ellipsis> âœ… Checkpoint de Conocimiento </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#141-estructura-de-una-api-ml class=md-nav__link> <span class=md-ellipsis> 14.1 Estructura de una API ML </span> </a> <nav class=md-nav aria-label="14.1 Estructura de una API ML"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#anatomia-tipica class=md-nav__link> <span class=md-ellipsis> AnatomÃ­a TÃ­pica </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#142-schemas-con-pydantic class=md-nav__link> <span class=md-ellipsis> 14.2 Schemas con Pydantic </span> </a> <nav class=md-nav aria-label="14.2 Schemas con Pydantic"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#requestresponse-models class=md-nav__link> <span class=md-ellipsis> Request/Response Models </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#143-endpoints-de-prediccion class=md-nav__link> <span class=md-ellipsis> 14.3 Endpoints de PredicciÃ³n </span> </a> <nav class=md-nav aria-label="14.3 Endpoints de PredicciÃ³n"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#single-prediction class=md-nav__link> <span class=md-ellipsis> Single Prediction </span> </a> </li> <li class=md-nav__item> <a href=#batch-prediction class=md-nav__link> <span class=md-ellipsis> Batch Prediction </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#144-error-handling class=md-nav__link> <span class=md-ellipsis> 14.4 Error Handling </span> </a> <nav class=md-nav aria-label="14.4 Error Handling"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-exception-handlers class=md-nav__link> <span class=md-ellipsis> Custom Exception Handlers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#145-codigo-real-del-portafolio class=md-nav__link> <span class=md-ellipsis> 14.5 CÃ³digo Real del Portafolio </span> </a> <nav class=md-nav aria-label="14.5 CÃ³digo Real del Portafolio"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#appfastapi_apppy-bankchurn-simplificado class=md-nav__link> <span class=md-ellipsis> app/fastapi_app.py (BankChurn - Simplificado) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#146-ingenieria-inversa-pedagogica-api-de-produccion-real class=md-nav__link> <span class=md-ellipsis> 14.6 ğŸ”¬ IngenierÃ­a Inversa PedagÃ³gica: API de ProducciÃ³n Real </span> </a> <nav class=md-nav aria-label="14.6 ğŸ”¬ IngenierÃ­a Inversa PedagÃ³gica: API de ProducciÃ³n Real"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1461-el-por-que-arquitectonico class=md-nav__link> <span class=md-ellipsis> 14.6.1 ğŸ¯ El "Por QuÃ©" ArquitectÃ³nico </span> </a> </li> <li class=md-nav__item> <a href=#1462-anatomia-de-appfastapi_apppy class=md-nav__link> <span class=md-ellipsis> 14.6.2 ğŸ” AnatomÃ­a de app/fastapi_app.py </span> </a> </li> <li class=md-nav__item> <a href=#1463-laboratorio-de-replicacion class=md-nav__link> <span class=md-ellipsis> 14.6.3 ğŸ§ª Laboratorio de ReplicaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=#1464-troubleshooting-preventivo class=md-nav__link> <span class=md-ellipsis> 14.6.4 ğŸš¨ Troubleshooting Preventivo </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#errores-habituales-y-como-depurarlos-en-fastapi-para-ml class=md-nav__link> <span class=md-ellipsis> ğŸ§¨ Errores habituales y cÃ³mo depurarlos en FastAPI para ML </span> </a> <nav class=md-nav aria-label="ğŸ§¨ Errores habituales y cÃ³mo depurarlos en FastAPI para ML"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-el-modelo-no-se-carga-503-constantes class=md-nav__link> <span class=md-ellipsis> 1) El modelo no se carga (503 constantes) </span> </a> </li> <li class=md-nav__item> <a href=#2-esquema-pydantic-desalineado-con-el-pipeline class=md-nav__link> <span class=md-ellipsis> 2) Esquema Pydantic desalineado con el pipeline </span> </a> </li> <li class=md-nav__item> <a href=#3-problemas-de-tipos-y-serializacion class=md-nav__link> <span class=md-ellipsis> 3) Problemas de tipos y serializaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=#4-cors-o-healthcheck-mal-configurados class=md-nav__link> <span class=md-ellipsis> 4) CORS o healthcheck mal configurados </span> </a> </li> <li class=md-nav__item> <a href=#5-patron-general-de-debugging-en-apis-de-ml class=md-nav__link> <span class=md-ellipsis> 5) PatrÃ³n general de debugging en APIs de ML </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ejercicio class=md-nav__link> <span class=md-ellipsis> âœ… Ejercicio </span> </a> </li> <li class=md-nav__item> <a href=#como-se-uso-en-el-portafolio class=md-nav__link> <span class=md-ellipsis> ğŸ“¦ CÃ³mo se UsÃ³ en el Portafolio </span> </a> <nav class=md-nav aria-label="ğŸ“¦ CÃ³mo se UsÃ³ en el Portafolio"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#api-de-bankchurn class=md-nav__link> <span class=md-ellipsis> API de BankChurn </span> </a> </li> <li class=md-nav__item> <a href=#apis-por-proyecto class=md-nav__link> <span class=md-ellipsis> APIs por Proyecto </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-prueba-las-apis-reales class=md-nav__link> <span class=md-ellipsis> ğŸ”§ Ejercicio: Prueba las APIs Reales </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#checkpoint class=md-nav__link> <span class=md-ellipsis> âœ… Checkpoint </span> </a> </li> <li class=md-nav__item> <a href=#consejos-profesionales class=md-nav__link> <span class=md-ellipsis> ğŸ’¼ Consejos Profesionales </span> </a> <nav class=md-nav aria-label="ğŸ’¼ Consejos Profesionales"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#para-entrevistas class=md-nav__link> <span class=md-ellipsis> Para Entrevistas </span> </a> </li> <li class=md-nav__item> <a href=#para-proyectos-reales class=md-nav__link> <span class=md-ellipsis> Para Proyectos Reales </span> </a> </li> <li class=md-nav__item> <a href=#endpoints-esenciales-para-ml class=md-nav__link> <span class=md-ellipsis> Endpoints Esenciales para ML </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#recursos-externos-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ“º Recursos Externos del MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸ“º Recursos Externos del MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#videos class=md-nav__link> <span class=md-ellipsis> ğŸ¬ Videos </span> </a> </li> <li class=md-nav__item> <a href=#documentacion class=md-nav__link> <span class=md-ellipsis> ğŸ“„ DocumentaciÃ³n </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#decision-tecnica-adr-004-fastapi class=md-nav__link> <span class=md-ellipsis> âš–ï¸ DecisiÃ³n TÃ©cnica: ADR-004 FastAPI </span> </a> </li> <li class=md-nav__item> <a href=#ejercicios-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ”§ Ejercicios del MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸ”§ Ejercicios del MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ejercicio-141-schemas-pydantic class=md-nav__link> <span class=md-ellipsis> Ejercicio 14.1: Schemas Pydantic </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-142-endpoint-completo class=md-nav__link> <span class=md-ellipsis> Ejercicio 14.2: Endpoint Completo </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#glosario-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ”— Glosario del MÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#la-trampa-errores-comunes-de-este-modulo class=md-nav__link> <span class=md-ellipsis> ğŸª¤ La Trampa â€” Errores Comunes de Este MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸª¤ La Trampa â€” Errores Comunes de Este MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#trampa-1-api-sin-validacion-de-entrada class=md-nav__link> <span class=md-ellipsis> Trampa 1: API sin validaciÃ³n de entrada </span> </a> </li> <li class=md-nav__item> <a href=#trampa-2-modelo-cargado-en-cada-request class=md-nav__link> <span class=md-ellipsis> Trampa 2: Modelo cargado en cada request </span> </a> </li> <li class=md-nav__item> <a href=#trampa-3-logs-sin-contexto-de-request class=md-nav__link> <span class=md-ellipsis> Trampa 3: Logs sin contexto de request </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#quiz-del-modulo-semanas-19-20 class=md-nav__link> <span class=md-ellipsis> ğŸ“ Quiz del MÃ³dulo â€” Semanas 19-20 </span> </a> <nav class=md-nav aria-label="ğŸ“ Quiz del MÃ³dulo â€” Semanas 19-20"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#quiz-semana-19-fastapi class=md-nav__link> <span class=md-ellipsis> Quiz Semana 19: FastAPI </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../15_STREAMLIT/ class=md-nav__link> <span class=md-ellipsis> 15 â€” Streamlit </span> </a> </li> <li class=md-nav__item> <a href=../16_OBSERVABILIDAD/ class=md-nav__link> <span class=md-ellipsis> 16 â€” Observabilidad </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> Fase 4 - ProducciÃ³n </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Fase 4 - ProducciÃ³n </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../17_DESPLIEGUE/ class=md-nav__link> <span class=md-ellipsis> 17 â€” Despliegue </span> </a> </li> <li class=md-nav__item> <a href=../18_INFRAESTRUCTURA/ class=md-nav__link> <span class=md-ellipsis> 18 â€” Infraestructura </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> Fase 5 - Senior/Staff </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> Fase 5 - Senior/Staff </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../19_DOCUMENTACION/ class=md-nav__link> <span class=md-ellipsis> 19 â€” DocumentaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=../20_OBSERVABILIDAD_AVANZADA_DRIFT/ class=md-nav__link> <span class=md-ellipsis> 20 â€” Observabilidad Avanzada </span> </a> </li> <li class=md-nav__item> <a href=../21_CLOUD_FINOPS/ class=md-nav__link> <span class=md-ellipsis> 21 â€” Cloud FinOps </span> </a> </li> <li class=md-nav__item> <a href=../22_IAC_EMPRESARIAL/ class=md-nav__link> <span class=md-ellipsis> 22 â€” IaC Empresarial </span> </a> </li> <li class=md-nav__item> <a href=../23_PROYECTO_INTEGRADOR/ class=md-nav__link> <span class=md-ellipsis> 23 â€” Proyecto Integrador </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex=0> <span class=md-ellipsis> Material de Apoyo </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Material de Apoyo </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../apoyo/ class=md-nav__link> <span class=md-ellipsis> Ãndice Apoyo </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/GLOSARIO/ class=md-nav__link> <span class=md-ellipsis> Glosario MLOps </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/CHECKLIST/ class=md-nav__link> <span class=md-ellipsis> Checklist Profesional </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/RECURSOS/ class=md-nav__link> <span class=md-ellipsis> Recursos Externos </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/RUBRICA_EVALUACION/ class=md-nav__link> <span class=md-ellipsis> RÃºbrica de EvaluaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/PLANTILLAS/ class=md-nav__link> <span class=md-ellipsis> Plantillas </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/GUIA_AUDIOVISUAL/ class=md-nav__link> <span class=md-ellipsis> GuÃ­a Audiovisual </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/MAINTENANCE_GUIDE/ class=md-nav__link> <span class=md-ellipsis> GuÃ­a de Mantenimiento </span> </a> </li> <li class=md-nav__item> <a href=../apoyo/GUIA_SCRIPTS_OPERACIONALES/ class=md-nav__link> <span class=md-ellipsis> Scripts Operacionales </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_12> <label class=md-nav__link for=__nav_12 id=__nav_12_label tabindex=0> <span class=md-ellipsis> Herramientas de Estudio </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_12_label aria-expanded=false> <label class=md-nav__title for=__nav_12> <span class="md-nav__icon md-icon"></span> Herramientas de Estudio </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../study_tools/ class=md-nav__link> <span class=md-ellipsis> Ãndice </span> </a> </li> <li class=md-nav__item> <a href=../study_tools/PROTOCOLO_E/ class=md-nav__link> <span class=md-ellipsis> Protocolo E </span> </a> </li> <li class=md-nav__item> <a href=../study_tools/DIARIO_ERRORES/ class=md-nav__link> <span class=md-ellipsis> Diario de Errores </span> </a> </li> <li class=md-nav__item> <a href=../study_tools/CIERRE_SEMANAL/ class=md-nav__link> <span class=md-ellipsis> Cierre Semanal </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_13> <label class=md-nav__link for=__nav_13 id=__nav_13_label tabindex=0> <span class=md-ellipsis> ExÃ¡menes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_13_label aria-expanded=false> <label class=md-nav__title for=__nav_13> <span class="md-nav__icon md-icon"></span> ExÃ¡menes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../exams/EXAM_01_SETUP/ class=md-nav__link> <span class=md-ellipsis> Exam 01 â€” Setup </span> </a> </li> <li class=md-nav__item> <a href=../../exams/EXAM_02_PIPELINE/ class=md-nav__link> <span class=md-ellipsis> Exam 02 â€” Pipeline </span> </a> </li> <li class=md-nav__item> <a href=../../exams/EXAM_03_TESTING/ class=md-nav__link> <span class=md-ellipsis> Exam 03 â€” Testing </span> </a> </li> <li class=md-nav__item> <a href=../../exams/EXAM_04_DEPLOYMENT/ class=md-nav__link> <span class=md-ellipsis> Exam 04 â€” Deployment </span> </a> </li> <li class=md-nav__item> <a href=../../exams/EXAM_05_PRODUCTION/ class=md-nav__link> <span class=md-ellipsis> Exam 05 â€” Production </span> </a> </li> <li class=md-nav__item> <a href=../../exams/EXAM_06_INTEGRATION/ class=md-nav__link> <span class=md-ellipsis> Exam 06 â€” Integration </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_14> <label class=md-nav__link for=__nav_14 id=__nav_14_label tabindex=0> <span class=md-ellipsis> Simulacros de Entrevista </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_14_label aria-expanded=false> <label class=md-nav__title for=__nav_14> <span class="md-nav__icon md-icon"></span> Simulacros de Entrevista </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../SIMULACRO_ENTREVISTA_JUNIOR/ class=md-nav__link> <span class=md-ellipsis> Junior </span> </a> </li> <li class=md-nav__item> <a href=../SIMULACRO_ENTREVISTA_MID/ class=md-nav__link> <span class=md-ellipsis> Mid </span> </a> </li> <li class=md-nav__item> <a href=../SIMULACRO_ENTREVISTA_SENIOR_PARTE1/ class=md-nav__link> <span class=md-ellipsis> Senior Parte 1 </span> </a> </li> <li class=md-nav__item> <a href=../SIMULACRO_ENTREVISTA_SENIOR_PARTE2/ class=md-nav__link> <span class=md-ellipsis> Senior Parte 2 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_15> <label class=md-nav__link for=__nav_15 id=__nav_15_label tabindex=0> <span class=md-ellipsis> Laboratorios </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_15_label aria-expanded=false> <label class=md-nav__title for=__nav_15> <span class="md-nav__icon md-icon"></span> Laboratorios </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../notebooks/labs/LAB_01_DOCKER_DEBUG/ class=md-nav__link> <span class=md-ellipsis> LAB 01 â€” Docker Debug </span> </a> </li> <li class=md-nav__item> <a href=../../notebooks/labs/LAB_02_PANDAS_PERFORMANCE/ class=md-nav__link> <span class=md-ellipsis> LAB 02 â€” Pandas Performance </span> </a> </li> <li class=md-nav__item> <a href=../../notebooks/labs/LAB_03_DEPENDENCY_CONFLICTS/ class=md-nav__link> <span class=md-ellipsis> LAB 03 â€” Dependency Conflicts </span> </a> </li> <li class=md-nav__item> <a href=../../notebooks/07_08_sklearn_pipelines/ class=md-nav__link> <span class=md-ellipsis> ğŸ”§ Notebook Interactivo: sklearn Pipelines y Feature Engineering </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_16> <label class=md-nav__link for=__nav_16 id=__nav_16_label tabindex=0> <span class=md-ellipsis> Plantillas </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_16_label aria-expanded=false> <label class=md-nav__title for=__nav_16> <span class="md-nav__icon md-icon"></span> Plantillas </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../templates/ class=md-nav__link> <span class=md-ellipsis> Ãndice Plantillas </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Tabla de contenidos </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#00-prerrequisitos class=md-nav__link> <span class=md-ellipsis> 0.0 Prerrequisitos </span> </a> </li> <li class=md-nav__item> <a href=#01-protocolo-e-como-estudiar-este-modulo class=md-nav__link> <span class=md-ellipsis> 0.1 ğŸ§  Protocolo E: CÃ³mo estudiar este mÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#02-entregables-verificables-minimo-viable class=md-nav__link> <span class=md-ellipsis> 0.2 âœ… Entregables verificables (mÃ­nimo viable) </span> </a> </li> <li class=md-nav__item> <a href=#03-puente-teoria-codigo-portafolio class=md-nav__link> <span class=md-ellipsis> 0.3 ğŸ§© Puente teorÃ­a â†” cÃ³digo (Portafolio) </span> </a> </li> <li class=md-nav__item> <a href=#objetivo-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ¯ Objetivo del MÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#contenido class=md-nav__link> <span class=md-ellipsis> ğŸ“‹ Contenido </span> </a> <nav class=md-nav aria-label="ğŸ“‹ Contenido"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mapa-mental-de-conceptos-fastapi-para-ml class=md-nav__link> <span class=md-ellipsis> ğŸ§  Mapa Mental de Conceptos: FastAPI para ML </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-puente-api-minima class=md-nav__link> <span class=md-ellipsis> ğŸ’» Ejercicio Puente: API MÃ­nima </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-puente-apis-ml class=md-nav__link> <span class=md-ellipsis> ğŸ’» Ejercicio Puente: APIs ML </span> </a> </li> <li class=md-nav__item> <a href=#practica-del-portafolio-fastapi-en-bankchurn class=md-nav__link> <span class=md-ellipsis> ğŸ› ï¸ PrÃ¡ctica del Portafolio: FastAPI en BankChurn </span> </a> </li> <li class=md-nav__item> <a href=#checkpoint-de-conocimiento class=md-nav__link> <span class=md-ellipsis> âœ… Checkpoint de Conocimiento </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#141-estructura-de-una-api-ml class=md-nav__link> <span class=md-ellipsis> 14.1 Estructura de una API ML </span> </a> <nav class=md-nav aria-label="14.1 Estructura de una API ML"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#anatomia-tipica class=md-nav__link> <span class=md-ellipsis> AnatomÃ­a TÃ­pica </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#142-schemas-con-pydantic class=md-nav__link> <span class=md-ellipsis> 14.2 Schemas con Pydantic </span> </a> <nav class=md-nav aria-label="14.2 Schemas con Pydantic"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#requestresponse-models class=md-nav__link> <span class=md-ellipsis> Request/Response Models </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#143-endpoints-de-prediccion class=md-nav__link> <span class=md-ellipsis> 14.3 Endpoints de PredicciÃ³n </span> </a> <nav class=md-nav aria-label="14.3 Endpoints de PredicciÃ³n"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#single-prediction class=md-nav__link> <span class=md-ellipsis> Single Prediction </span> </a> </li> <li class=md-nav__item> <a href=#batch-prediction class=md-nav__link> <span class=md-ellipsis> Batch Prediction </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#144-error-handling class=md-nav__link> <span class=md-ellipsis> 14.4 Error Handling </span> </a> <nav class=md-nav aria-label="14.4 Error Handling"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#custom-exception-handlers class=md-nav__link> <span class=md-ellipsis> Custom Exception Handlers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#145-codigo-real-del-portafolio class=md-nav__link> <span class=md-ellipsis> 14.5 CÃ³digo Real del Portafolio </span> </a> <nav class=md-nav aria-label="14.5 CÃ³digo Real del Portafolio"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#appfastapi_apppy-bankchurn-simplificado class=md-nav__link> <span class=md-ellipsis> app/fastapi_app.py (BankChurn - Simplificado) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#146-ingenieria-inversa-pedagogica-api-de-produccion-real class=md-nav__link> <span class=md-ellipsis> 14.6 ğŸ”¬ IngenierÃ­a Inversa PedagÃ³gica: API de ProducciÃ³n Real </span> </a> <nav class=md-nav aria-label="14.6 ğŸ”¬ IngenierÃ­a Inversa PedagÃ³gica: API de ProducciÃ³n Real"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1461-el-por-que-arquitectonico class=md-nav__link> <span class=md-ellipsis> 14.6.1 ğŸ¯ El "Por QuÃ©" ArquitectÃ³nico </span> </a> </li> <li class=md-nav__item> <a href=#1462-anatomia-de-appfastapi_apppy class=md-nav__link> <span class=md-ellipsis> 14.6.2 ğŸ” AnatomÃ­a de app/fastapi_app.py </span> </a> </li> <li class=md-nav__item> <a href=#1463-laboratorio-de-replicacion class=md-nav__link> <span class=md-ellipsis> 14.6.3 ğŸ§ª Laboratorio de ReplicaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=#1464-troubleshooting-preventivo class=md-nav__link> <span class=md-ellipsis> 14.6.4 ğŸš¨ Troubleshooting Preventivo </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#errores-habituales-y-como-depurarlos-en-fastapi-para-ml class=md-nav__link> <span class=md-ellipsis> ğŸ§¨ Errores habituales y cÃ³mo depurarlos en FastAPI para ML </span> </a> <nav class=md-nav aria-label="ğŸ§¨ Errores habituales y cÃ³mo depurarlos en FastAPI para ML"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-el-modelo-no-se-carga-503-constantes class=md-nav__link> <span class=md-ellipsis> 1) El modelo no se carga (503 constantes) </span> </a> </li> <li class=md-nav__item> <a href=#2-esquema-pydantic-desalineado-con-el-pipeline class=md-nav__link> <span class=md-ellipsis> 2) Esquema Pydantic desalineado con el pipeline </span> </a> </li> <li class=md-nav__item> <a href=#3-problemas-de-tipos-y-serializacion class=md-nav__link> <span class=md-ellipsis> 3) Problemas de tipos y serializaciÃ³n </span> </a> </li> <li class=md-nav__item> <a href=#4-cors-o-healthcheck-mal-configurados class=md-nav__link> <span class=md-ellipsis> 4) CORS o healthcheck mal configurados </span> </a> </li> <li class=md-nav__item> <a href=#5-patron-general-de-debugging-en-apis-de-ml class=md-nav__link> <span class=md-ellipsis> 5) PatrÃ³n general de debugging en APIs de ML </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#ejercicio class=md-nav__link> <span class=md-ellipsis> âœ… Ejercicio </span> </a> </li> <li class=md-nav__item> <a href=#como-se-uso-en-el-portafolio class=md-nav__link> <span class=md-ellipsis> ğŸ“¦ CÃ³mo se UsÃ³ en el Portafolio </span> </a> <nav class=md-nav aria-label="ğŸ“¦ CÃ³mo se UsÃ³ en el Portafolio"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#api-de-bankchurn class=md-nav__link> <span class=md-ellipsis> API de BankChurn </span> </a> </li> <li class=md-nav__item> <a href=#apis-por-proyecto class=md-nav__link> <span class=md-ellipsis> APIs por Proyecto </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-prueba-las-apis-reales class=md-nav__link> <span class=md-ellipsis> ğŸ”§ Ejercicio: Prueba las APIs Reales </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#checkpoint class=md-nav__link> <span class=md-ellipsis> âœ… Checkpoint </span> </a> </li> <li class=md-nav__item> <a href=#consejos-profesionales class=md-nav__link> <span class=md-ellipsis> ğŸ’¼ Consejos Profesionales </span> </a> <nav class=md-nav aria-label="ğŸ’¼ Consejos Profesionales"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#para-entrevistas class=md-nav__link> <span class=md-ellipsis> Para Entrevistas </span> </a> </li> <li class=md-nav__item> <a href=#para-proyectos-reales class=md-nav__link> <span class=md-ellipsis> Para Proyectos Reales </span> </a> </li> <li class=md-nav__item> <a href=#endpoints-esenciales-para-ml class=md-nav__link> <span class=md-ellipsis> Endpoints Esenciales para ML </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#recursos-externos-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ“º Recursos Externos del MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸ“º Recursos Externos del MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#videos class=md-nav__link> <span class=md-ellipsis> ğŸ¬ Videos </span> </a> </li> <li class=md-nav__item> <a href=#documentacion class=md-nav__link> <span class=md-ellipsis> ğŸ“„ DocumentaciÃ³n </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#decision-tecnica-adr-004-fastapi class=md-nav__link> <span class=md-ellipsis> âš–ï¸ DecisiÃ³n TÃ©cnica: ADR-004 FastAPI </span> </a> </li> <li class=md-nav__item> <a href=#ejercicios-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ”§ Ejercicios del MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸ”§ Ejercicios del MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ejercicio-141-schemas-pydantic class=md-nav__link> <span class=md-ellipsis> Ejercicio 14.1: Schemas Pydantic </span> </a> </li> <li class=md-nav__item> <a href=#ejercicio-142-endpoint-completo class=md-nav__link> <span class=md-ellipsis> Ejercicio 14.2: Endpoint Completo </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#glosario-del-modulo class=md-nav__link> <span class=md-ellipsis> ğŸ”— Glosario del MÃ³dulo </span> </a> </li> <li class=md-nav__item> <a href=#la-trampa-errores-comunes-de-este-modulo class=md-nav__link> <span class=md-ellipsis> ğŸª¤ La Trampa â€” Errores Comunes de Este MÃ³dulo </span> </a> <nav class=md-nav aria-label="ğŸª¤ La Trampa â€” Errores Comunes de Este MÃ³dulo"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#trampa-1-api-sin-validacion-de-entrada class=md-nav__link> <span class=md-ellipsis> Trampa 1: API sin validaciÃ³n de entrada </span> </a> </li> <li class=md-nav__item> <a href=#trampa-2-modelo-cargado-en-cada-request class=md-nav__link> <span class=md-ellipsis> Trampa 2: Modelo cargado en cada request </span> </a> </li> <li class=md-nav__item> <a href=#trampa-3-logs-sin-contexto-de-request class=md-nav__link> <span class=md-ellipsis> Trampa 3: Logs sin contexto de request </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#quiz-del-modulo-semanas-19-20 class=md-nav__link> <span class=md-ellipsis> ğŸ“ Quiz del MÃ³dulo â€” Semanas 19-20 </span> </a> <nav class=md-nav aria-label="ğŸ“ Quiz del MÃ³dulo â€” Semanas 19-20"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#quiz-semana-19-fastapi class=md-nav__link> <span class=md-ellipsis> Quiz Semana 19: FastAPI </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=14-fastapi-para-produccion>14. FastAPI para ProducciÃ³n<a class=headerlink href=#14-fastapi-para-produccion title="Permanent link">&para;</a></h1> <p><a id=00-prerrequisitos></a></p> <h2 id=00-prerrequisitos>0.0 Prerrequisitos<a class=headerlink href=#00-prerrequisitos title="Permanent link">&para;</a></h2> <ul> <li>Tener un proyecto con FastAPI ejecutable (local o en contenedor).</li> <li>Conocer validaciÃ³n con Pydantic (modelos request/response).</li> <li>Haber completado el mÃ³dulo 13 (Docker) para empaquetar y ejecutar la API.</li> </ul> <hr> <p><a id=01-protocolo-e-como-estudiar-este-modulo></a></p> <h2 id=01-protocolo-e-como-estudiar-este-modulo>0.1 ğŸ§  Protocolo E: CÃ³mo estudiar este mÃ³dulo<a class=headerlink href=#01-protocolo-e-como-estudiar-este-modulo title="Permanent link">&para;</a></h2> <ul> <li><strong>Antes de empezar</strong>: abre <strong><a href=../study_tools/PROTOCOLO_E/ >Protocolo E</a></strong> y define el output mÃ­nimo: un servicio que levanta y responde en <code>/health</code> y <code>/predict</code>.</li> <li><strong>Durante el debugging</strong>: si te atoras &gt;15 min (schema, serializaciÃ³n, modelo no carga, 4xx/5xx), registra el caso en <strong><a href=../study_tools/DIARIO_ERRORES/ >Diario de Errores</a></strong>.</li> <li><strong>Al cierre de semana</strong>: usa <strong><a href=../study_tools/CIERRE_SEMANAL/ >Cierre Semanal</a></strong> para auditar documentaciÃ³n (OpenAPI), manejo de errores y compatibilidad training-serving.</li> </ul> <hr> <p><a id=02-entregables-verificables-minimo-viable></a></p> <h2 id=02-entregables-verificables-minimo-viable>0.2 âœ… Entregables verificables (mÃ­nimo viable)<a class=headerlink href=#02-entregables-verificables-minimo-viable title="Permanent link">&para;</a></h2> <ul> <li>[ ] Endpoint <code>/health</code> estable (sin depender de cÃ³mputo pesado).</li> <li>[ ] Endpoint <code>/predict</code> con request/response validados (Pydantic).</li> <li>[ ] DocumentaciÃ³n accesible en <code>/docs</code> (Swagger) y <code>/openapi.json</code>.</li> <li>[ ] Manejo de errores consistente (<code>HTTPException</code> + cÃ³digos).</li> <li>[ ] ConversiÃ³n explÃ­cita a tipos nativos (<code>float</code>, <code>int</code>) para evitar problemas de serializaciÃ³n.</li> </ul> <hr> <p><a id=03-puente-teoria-codigo-portafolio></a></p> <h2 id=03-puente-teoria-codigo-portafolio>0.3 ğŸ§© Puente teorÃ­a â†” cÃ³digo (Portafolio)<a class=headerlink href=#03-puente-teoria-codigo-portafolio title="Permanent link">&para;</a></h2> <ul> <li><strong>Concepto</strong>: contrato API (schemas) + loading de modelo (startup) + observabilidad bÃ¡sica</li> <li><strong>Archivo</strong>: <code>app/fastapi_app.py</code>, <code>app/schemas.py</code></li> <li><strong>Prueba</strong>: <code>uvicorn app.fastapi_app:app --reload</code> y <code>curl http://localhost:8000/health</code></li> </ul> <hr> <h2 id=objetivo-del-modulo>ğŸ¯ Objetivo del MÃ³dulo<a class=headerlink href=#objetivo-del-modulo title="Permanent link">&para;</a></h2> <p>Construir APIs de ML robustas, documentadas y production-ready como las del portafolio.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>â•‘                                                                              â•‘
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>â•‘  FastAPI = El framework ideal para ML APIs                                   â•‘
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>â•‘                                                                              â•‘
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>â•‘  âœ… Type hints nativos (Pydantic)                                            â•‘
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>â•‘  âœ… DocumentaciÃ³n automÃ¡tica (Swagger/OpenAPI)                               â•‘
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>â•‘  âœ… Async support (alto throughput)                                          â•‘
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>â•‘  âœ… ValidaciÃ³n automÃ¡tica de requests                                        â•‘
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>â•‘  âœ… Dependency Injection built-in                                            â•‘
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>â•‘                                                                              â•‘
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</code></pre></div> <hr> <h2 id=contenido>ğŸ“‹ Contenido<a class=headerlink href=#contenido title="Permanent link">&para;</a></h2> <ul> <li><strong>0.0</strong> <a href=#00-prerrequisitos>Prerrequisitos</a></li> <li><strong>0.1</strong> <a href=#01-protocolo-e-como-estudiar-este-modulo>Protocolo E: CÃ³mo estudiar este mÃ³dulo</a></li> <li><strong>0.2</strong> <a href=#02-entregables-verificables-minimo-viable>Entregables verificables (mÃ­nimo viable)</a></li> <li><strong>0.3</strong> <a href=#03-puente-teoria-codigo-portafolio>Puente teorÃ­a â†” cÃ³digo (Portafolio)</a></li> <li><strong>14.1</strong> <a href=#141-estructura-de-una-api-ml>Estructura de una API ML</a></li> <li><strong>14.2</strong> <a href=#142-schemas-con-pydantic>Schemas con Pydantic</a></li> <li><strong>14.3</strong> <a href=#143-endpoints-de-prediccion>Endpoints de PredicciÃ³n</a></li> <li><strong>14.4</strong> <a href=#144-error-handling>Error Handling</a></li> <li><strong>14.5</strong> <a href=#145-codigo-real-del-portafolio>CÃ³digo Real del Portafolio</a></li> <li><strong>14.6</strong> <a href=#146-ingenieria-inversa-fastapi>ğŸ”¬ IngenierÃ­a Inversa: API ProducciÃ³n Real</a> â­ NUEVO</li> <li><a href=#errores-habituales>Errores habituales</a></li> <li><a href=#checkpoint>âœ… Checkpoint</a></li> <li><a href=#ejercicio>âœ… Ejercicio</a></li> </ul> <hr> <p><a id=141-estructura-de-una-api-ml></a></p> <h3 id=mapa-mental-de-conceptos-fastapi-para-ml>ğŸ§  Mapa Mental de Conceptos: FastAPI para ML<a class=headerlink href=#mapa-mental-de-conceptos-fastapi-para-ml title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>                          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>                          â•‘      FASTAPI PARA ML PRODUCTION      â•‘
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>                          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>                                            â”‚
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>         â–¼                                  â–¼                                  â–¼
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>â”‚    ENDPOINTS     â”‚              â”‚    SCHEMAS       â”‚              â”‚   LIFECYCLE      â”‚
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>       â”‚                                 â”‚                                 â”‚
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>â”œâ”€ /health                        â”œâ”€ PredictionRequest          â”œâ”€ Startup: load model
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>â”œâ”€ /predict                       â”œâ”€ PredictionResponse         â”œâ”€ Shutdown: cleanup
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>â”œâ”€ /batch                         â”œâ”€ ValidaciÃ³n Pydantic        â””â”€ Global state
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>â””â”€ /docs (auto)                   â””â”€ OpenAPI spec
</code></pre></div> <p><strong>TÃ©rminos clave:</strong></p> <table> <thead> <tr> <th>TÃ©rmino</th> <th>Significado</th> <th>Ejemplo</th> </tr> </thead> <tbody> <tr> <td><strong>Schema</strong></td> <td>Modelo Pydantic para validar I/O</td> <td><code>PredictionRequest</code></td> </tr> <tr> <td><strong>Lifespan</strong></td> <td>Startup/shutdown hooks</td> <td>Cargar modelo una vez</td> </tr> <tr> <td><strong>HTTPException</strong></td> <td>Error HTTP estructurado</td> <td><code>HTTPException(404, "Not found")</code></td> </tr> <tr> <td><strong>Dependency</strong></td> <td>InyecciÃ³n de dependencias</td> <td>ConexiÃ³n DB, auth</td> </tr> </tbody> </table> <hr> <h3 id=ejercicio-puente-api-minima>ğŸ’» Ejercicio Puente: API MÃ­nima<a class=headerlink href=#ejercicio-puente-api-minima title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>  <span class=c1># Crea la aplicaciÃ³n FastAPI.</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>)</span>  <span class=c1># Endpoint GET para health check.</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=k>def</span><span class=w> </span><span class=nf>health</span><span class=p>():</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;healthy&quot;</span><span class=p>}</span>  <span class=c1># Respuesta JSON indicando que el servicio estÃ¡ activo.</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>  <span class=c1># Endpoint POST para predicciones.</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>    <span class=c1># TU TAREA: Cargar modelo y predecir</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;prediction&quot;</span><span class=p>:</span> <span class=mf>0.85</span><span class=p>}</span>  <span class=c1># Respuesta con la predicciÃ³n del modelo.</span>
</code></pre></div> <p><strong>Ejecutar:</strong> <code>uvicorn app:app --reload</code> <strong>Ver docs:</strong> <code>http://localhost:8000/docs</code></p> <hr> <h3 id=ejercicio-puente-apis-ml>ğŸ’» Ejercicio Puente: APIs ML<a class=headerlink href=#ejercicio-puente-apis-ml title="Permanent link">&para;</a></h3> <blockquote> <p><strong>Meta</strong>: Practica el concepto antes de aplicarlo al portafolio.</p> </blockquote> <p><strong>Ejercicio bÃ¡sico:</strong> 1. Lee la secciÃ³n teÃ³rica siguiente 2. Identifica los patrones clave del cÃ³digo de ejemplo 3. Replica el patrÃ³n en un proyecto de prueba</p> <hr> <h3 id=practica-del-portafolio-fastapi-en-bankchurn>ğŸ› ï¸ PrÃ¡ctica del Portafolio: FastAPI en BankChurn<a class=headerlink href=#practica-del-portafolio-fastapi-en-bankchurn title="Permanent link">&para;</a></h3> <blockquote> <p><strong>Tarea</strong>: Aplicar este mÃ³dulo en BankChurn-Predictor.</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nb>cd</span><span class=w> </span>BankChurn-Predictor
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=c1># Explora el cÃ³digo relacionado con APIs ML</span>
</code></pre></div> <p><strong>Checklist:</strong> - [ ] LocalicÃ© el cÃ³digo relevante - [ ] EntendÃ­ la implementaciÃ³n actual - [ ] IdentifiquÃ© posibles mejoras</p> <hr> <h3 id=checkpoint-de-conocimiento>âœ… Checkpoint de Conocimiento<a class=headerlink href=#checkpoint-de-conocimiento title="Permanent link">&para;</a></h3> <p><strong>Pregunta 1</strong>: Â¿CuÃ¡l es el objetivo principal de FastAPI?</p> <p><strong>Pregunta 2</strong>: Â¿CÃ³mo se implementa en el portafolio?</p> <p><strong>ğŸ”§ Escenario Debugging</strong>: Si algo falla en APIs ML, Â¿cuÃ¡l serÃ­a tu primer paso de diagnÃ³stico?</p> <h2 id=141-estructura-de-una-api-ml>14.1 Estructura de una API ML<a class=headerlink href=#141-estructura-de-una-api-ml title="Permanent link">&para;</a></h2> <h3 id=anatomia-tipica>AnatomÃ­a TÃ­pica<a class=headerlink href=#anatomia-tipica title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=c1># app/fastapi_app.py - Estructura profesional</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>from</span><span class=w> </span><span class=nn>contextlib</span><span class=w> </span><span class=kn>import</span> <span class=n>asynccontextmanager</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=kn>from</span><span class=w> </span><span class=nn>pathlib</span><span class=w> </span><span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=kn>import</span><span class=w> </span><span class=nn>joblib</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi.middleware.cors</span><span class=w> </span><span class=kn>import</span> <span class=n>CORSMiddleware</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=kn>from</span><span class=w> </span><span class=nn>.schemas</span><span class=w> </span><span class=kn>import</span> <span class=n>PredictionRequest</span><span class=p>,</span> <span class=n>PredictionResponse</span><span class=p>,</span> <span class=n>HealthResponse</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=c1># LIFECYCLE: Cargar modelo al iniciar</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>                             <span class=c1># Variable global: accesible desde todos los endpoints.</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=nd>@asynccontextmanager</span>                     <span class=c1># Decorador para crear context manager async.</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>):</span>        <span class=c1># FunciÃ³n que gestiona startup/shutdown de la app.</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Lifecycle: carga modelo al iniciar, limpia al cerrar.&quot;&quot;&quot;</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>    <span class=k>global</span> <span class=n>model</span>                         <span class=c1># global: permite modificar la variable global desde aquÃ­.</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>    <span class=c1># Startup: cargar modelo</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a>    <span class=n>model_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;artifacts/model.joblib&quot;</span><span class=p>)</span>  <span class=c1># Ruta al modelo serializado.</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>    <span class=k>if</span> <span class=n>model_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>              <span class=c1># Verifica que el archivo existe antes de cargar.</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>        <span class=n>model</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>  <span class=c1># Deserializa el pipeline completo.</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;âœ… Modelo cargado: </span><span class=si>{</span><span class=n>model_path</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;âš ï¸ Modelo no encontrado: </span><span class=si>{</span><span class=n>model_path</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>  <span class=c1># Warning, no crash.</span>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a>    <span class=k>yield</span>                                <span class=c1># yield: aquÃ­ la app estÃ¡ corriendo y recibiendo requests.</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a>    <span class=c1># Shutdown: limpiar recursos</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a>    <span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>                         <span class=c1># Libera memoria al cerrar.</span>
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ğŸ›‘ App cerrada&quot;</span><span class=p>)</span>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a>
<a id=__codelineno-4-39 name=__codelineno-4-39 href=#__codelineno-4-39></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-40 name=__codelineno-4-40 href=#__codelineno-4-40></a><span class=c1># APP SETUP</span>
<a id=__codelineno-4-41 name=__codelineno-4-41 href=#__codelineno-4-41></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-42 name=__codelineno-4-42 href=#__codelineno-4-42></a>
<a id=__codelineno-4-43 name=__codelineno-4-43 href=#__codelineno-4-43></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>                           <span class=c1># Crea instancia de la aplicaciÃ³n FastAPI.</span>
<a id=__codelineno-4-44 name=__codelineno-4-44 href=#__codelineno-4-44></a>    <span class=n>title</span><span class=o>=</span><span class=s2>&quot;BankChurn Predictor API&quot;</span><span class=p>,</span>     <span class=c1># TÃ­tulo en Swagger UI (/docs).</span>
<a id=__codelineno-4-45 name=__codelineno-4-45 href=#__codelineno-4-45></a>    <span class=n>description</span><span class=o>=</span><span class=s2>&quot;API para predicciÃ³n de churn de clientes bancarios&quot;</span><span class=p>,</span>
<a id=__codelineno-4-46 name=__codelineno-4-46 href=#__codelineno-4-46></a>    <span class=n>version</span><span class=o>=</span><span class=s2>&quot;1.0.0&quot;</span><span class=p>,</span>                     <span class=c1># VersiÃ³n de la API (semver).</span>
<a id=__codelineno-4-47 name=__codelineno-4-47 href=#__codelineno-4-47></a>    <span class=n>lifespan</span><span class=o>=</span><span class=n>lifespan</span><span class=p>,</span>                   <span class=c1># Asocia el lifecycle manager definido arriba.</span>
<a id=__codelineno-4-48 name=__codelineno-4-48 href=#__codelineno-4-48></a><span class=p>)</span>
<a id=__codelineno-4-49 name=__codelineno-4-49 href=#__codelineno-4-49></a>
<a id=__codelineno-4-50 name=__codelineno-4-50 href=#__codelineno-4-50></a><span class=c1># CORS para permitir requests desde frontend</span>
<a id=__codelineno-4-51 name=__codelineno-4-51 href=#__codelineno-4-51></a><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span>                      <span class=c1># Middleware: procesa requests antes/despuÃ©s de endpoints.</span>
<a id=__codelineno-4-52 name=__codelineno-4-52 href=#__codelineno-4-52></a>    <span class=n>CORSMiddleware</span><span class=p>,</span>                      <span class=c1># Cross-Origin Resource Sharing: permite requests desde otros dominios.</span>
<a id=__codelineno-4-53 name=__codelineno-4-53 href=#__codelineno-4-53></a>    <span class=n>allow_origins</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>                 <span class=c1># &quot;*&quot; permite todo. En prod: [&quot;https://midominio.com&quot;].</span>
<a id=__codelineno-4-54 name=__codelineno-4-54 href=#__codelineno-4-54></a>    <span class=n>allow_credentials</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>              <span class=c1># Permite enviar cookies/auth headers.</span>
<a id=__codelineno-4-55 name=__codelineno-4-55 href=#__codelineno-4-55></a>    <span class=n>allow_methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>                 <span class=c1># Permite todos los mÃ©todos HTTP (GET, POST, etc.).</span>
<a id=__codelineno-4-56 name=__codelineno-4-56 href=#__codelineno-4-56></a>    <span class=n>allow_headers</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>                 <span class=c1># Permite todos los headers.</span>
<a id=__codelineno-4-57 name=__codelineno-4-57 href=#__codelineno-4-57></a><span class=p>)</span>
<a id=__codelineno-4-58 name=__codelineno-4-58 href=#__codelineno-4-58></a>
<a id=__codelineno-4-59 name=__codelineno-4-59 href=#__codelineno-4-59></a>
<a id=__codelineno-4-60 name=__codelineno-4-60 href=#__codelineno-4-60></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-61 name=__codelineno-4-61 href=#__codelineno-4-61></a><span class=c1># ENDPOINTS</span>
<a id=__codelineno-4-62 name=__codelineno-4-62 href=#__codelineno-4-62></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-4-63 name=__codelineno-4-63 href=#__codelineno-4-63></a>
<a id=__codelineno-4-64 name=__codelineno-4-64 href=#__codelineno-4-64></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>HealthResponse</span><span class=p>)</span>  <span class=c1># GET /health â†’ devuelve HealthResponse.</span>
<a id=__codelineno-4-65 name=__codelineno-4-65 href=#__codelineno-4-65></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>health_check</span><span class=p>():</span>                <span class=c1># async: permite I/O no bloqueante (mejor concurrencia).</span>
<a id=__codelineno-4-66 name=__codelineno-4-66 href=#__codelineno-4-66></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Health check endpoint para load balancers/k8s.&quot;&quot;&quot;</span>
<a id=__codelineno-4-67 name=__codelineno-4-67 href=#__codelineno-4-67></a>    <span class=k>return</span> <span class=n>HealthResponse</span><span class=p>(</span>               <span class=c1># Pydantic valida que el response cumpla el schema.</span>
<a id=__codelineno-4-68 name=__codelineno-4-68 href=#__codelineno-4-68></a>        <span class=n>status</span><span class=o>=</span><span class=s2>&quot;healthy&quot;</span> <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s2>&quot;degraded&quot;</span><span class=p>,</span>  <span class=c1># Ternario: condiciÃ³n ? si : no.</span>
<a id=__codelineno-4-69 name=__codelineno-4-69 href=#__codelineno-4-69></a>        <span class=n>model_loaded</span><span class=o>=</span><span class=n>model</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-4-70 name=__codelineno-4-70 href=#__codelineno-4-70></a>        <span class=n>version</span><span class=o>=</span><span class=s2>&quot;1.0.0&quot;</span>
<a id=__codelineno-4-71 name=__codelineno-4-71 href=#__codelineno-4-71></a>    <span class=p>)</span>
<a id=__codelineno-4-72 name=__codelineno-4-72 href=#__codelineno-4-72></a>
<a id=__codelineno-4-73 name=__codelineno-4-73 href=#__codelineno-4-73></a>
<a id=__codelineno-4-74 name=__codelineno-4-74 href=#__codelineno-4-74></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionResponse</span><span class=p>)</span>  <span class=c1># POST /predict con body JSON.</span>
<a id=__codelineno-4-75 name=__codelineno-4-75 href=#__codelineno-4-75></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictionRequest</span><span class=p>):</span>  <span class=c1># request: Pydantic valida el body automÃ¡ticamente.</span>
<a id=__codelineno-4-76 name=__codelineno-4-76 href=#__codelineno-4-76></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Predice probabilidad de churn para un cliente.&quot;&quot;&quot;</span>
<a id=__codelineno-4-77 name=__codelineno-4-77 href=#__codelineno-4-77></a>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>                    <span class=c1># VerificaciÃ³n defensiva.</span>
<a id=__codelineno-4-78 name=__codelineno-4-78 href=#__codelineno-4-78></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Modelo no disponible&quot;</span><span class=p>)</span>  <span class=c1># 503: Service Unavailable.</span>
<a id=__codelineno-4-79 name=__codelineno-4-79 href=#__codelineno-4-79></a>
<a id=__codelineno-4-80 name=__codelineno-4-80 href=#__codelineno-4-80></a>    <span class=c1># Convertir request a DataFrame</span>
<a id=__codelineno-4-81 name=__codelineno-4-81 href=#__codelineno-4-81></a>    <span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>                  <span class=c1># Import dentro de funciÃ³n (lazy load, ok en endpoints).</span>
<a id=__codelineno-4-82 name=__codelineno-4-82 href=#__codelineno-4-82></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>request</span><span class=o>.</span><span class=n>dict</span><span class=p>()])</span>  <span class=c1># dict(): convierte Pydantic model a diccionario.</span>
<a id=__codelineno-4-83 name=__codelineno-4-83 href=#__codelineno-4-83></a>
<a id=__codelineno-4-84 name=__codelineno-4-84 href=#__codelineno-4-84></a>    <span class=c1># Predecir</span>
<a id=__codelineno-4-85 name=__codelineno-4-85 href=#__codelineno-4-85></a>    <span class=n>proba</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>df</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>  <span class=c1># [0, 1]: fila 0, columna 1 (prob clase positiva).</span>
<a id=__codelineno-4-86 name=__codelineno-4-86 href=#__codelineno-4-86></a>    <span class=n>prediction</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.5</span><span class=p>)</span>       <span class=c1># Umbral 0.5: convierte probabilidad a 0/1.</span>
<a id=__codelineno-4-87 name=__codelineno-4-87 href=#__codelineno-4-87></a>
<a id=__codelineno-4-88 name=__codelineno-4-88 href=#__codelineno-4-88></a>    <span class=k>return</span> <span class=n>PredictionResponse</span><span class=p>(</span>           <span class=c1># Response tipado y validado.</span>
<a id=__codelineno-4-89 name=__codelineno-4-89 href=#__codelineno-4-89></a>        <span class=n>prediction</span><span class=o>=</span><span class=n>prediction</span><span class=p>,</span>
<a id=__codelineno-4-90 name=__codelineno-4-90 href=#__codelineno-4-90></a>        <span class=n>probability</span><span class=o>=</span><span class=nb>round</span><span class=p>(</span><span class=n>proba</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>     <span class=c1># round: 4 decimales de precisiÃ³n.</span>
<a id=__codelineno-4-91 name=__codelineno-4-91 href=#__codelineno-4-91></a>        <span class=n>risk_level</span><span class=o>=</span><span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;medium&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.3</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>  <span class=c1># Ternario encadenado.</span>
<a id=__codelineno-4-92 name=__codelineno-4-92 href=#__codelineno-4-92></a>    <span class=p>)</span>
</code></pre></div> <hr> <p><a id=142-schemas-con-pydantic></a></p> <h2 id=142-schemas-con-pydantic>14.2 Schemas con Pydantic<a class=headerlink href=#142-schemas-con-pydantic title="Permanent link">&para;</a></h2> <h3 id=requestresponse-models>Request/Response Models<a class=headerlink href=#requestresponse-models title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=c1># app/schemas.py</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Literal</span><span class=p>,</span> <span class=n>Optional</span>       <span class=c1># Literal: valores especÃ­ficos; Optional: puede ser None.</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>validator</span>  <span class=c1># BaseModel: clase base para schemas.</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=k>class</span><span class=w> </span><span class=nc>PredictionRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>        <span class=c1># Hereda de BaseModel: obtiene validaciÃ³n automÃ¡tica.</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para request de predicciÃ³n.</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=sd>    Pydantic valida automÃ¡ticamente:</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=sd>    - Tipos correctos</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=sd>    - Rangos vÃ¡lidos</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=sd>    - Valores permitidos</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>    <span class=n>CreditScore</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>850</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Credit score del cliente&quot;</span><span class=p>)</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>    <span class=c1># Field(...): ... significa REQUERIDO. ge=300: mayor o igual. le=850: menor o igual.</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>    <span class=n>Geography</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&quot;France&quot;</span><span class=p>,</span> <span class=s2>&quot;Germany&quot;</span><span class=p>,</span> <span class=s2>&quot;Spain&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;PaÃ­s&quot;</span><span class=p>)</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>    <span class=c1># Literal: SOLO acepta estos 3 valores exactos. Otros â†’ ValidationError.</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>    <span class=n>Gender</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&quot;Male&quot;</span><span class=p>,</span> <span class=s2>&quot;Female&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;GÃ©nero&quot;</span><span class=p>)</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>    <span class=n>Age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Edad&quot;</span><span class=p>)</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>    <span class=n>Tenure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;AÃ±os como cliente&quot;</span><span class=p>)</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>    <span class=n>Balance</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Balance en cuenta&quot;</span><span class=p>)</span>  <span class=c1># ge=0: no negativo.</span>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=n>NumOfProducts</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;NÃºmero de productos&quot;</span><span class=p>)</span>
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>    <span class=n>HasCrCard</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Tiene tarjeta de crÃ©dito&quot;</span><span class=p>)</span>  <span class=c1># Binario.</span>
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>    <span class=n>IsActiveMember</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Es miembro activo&quot;</span><span class=p>)</span>
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>    <span class=n>EstimatedSalary</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Salario estimado&quot;</span><span class=p>)</span>
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>
<a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>    <span class=k>class</span><span class=w> </span><span class=nc>Config</span><span class=p>:</span>                          <span class=c1># Config: configuraciÃ³n del modelo Pydantic.</span>
<a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>        <span class=n>json_schema_extra</span> <span class=o>=</span> <span class=p>{</span>              <span class=c1># Ejemplo para Swagger UI (/docs).</span>
<a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>            <span class=s2>&quot;example&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>                <span class=s2>&quot;CreditScore&quot;</span><span class=p>:</span> <span class=mi>650</span><span class=p>,</span>
<a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>                <span class=s2>&quot;Geography&quot;</span><span class=p>:</span> <span class=s2>&quot;France&quot;</span><span class=p>,</span>
<a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>                <span class=s2>&quot;Gender&quot;</span><span class=p>:</span> <span class=s2>&quot;Female&quot;</span><span class=p>,</span>
<a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>                <span class=s2>&quot;Age&quot;</span><span class=p>:</span> <span class=mi>40</span><span class=p>,</span>
<a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a>                <span class=s2>&quot;Tenure&quot;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
<a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>                <span class=s2>&quot;Balance&quot;</span><span class=p>:</span> <span class=mf>60000.0</span><span class=p>,</span>
<a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>                <span class=s2>&quot;NumOfProducts&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
<a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a>                <span class=s2>&quot;HasCrCard&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
<a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a>                <span class=s2>&quot;IsActiveMember&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
<a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a>                <span class=s2>&quot;EstimatedSalary&quot;</span><span class=p>:</span> <span class=mf>50000.0</span>
<a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a>            <span class=p>}</span>
<a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a>        <span class=p>}</span>
<a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a>
<a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a>
<a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a><span class=k>class</span><span class=w> </span><span class=nc>PredictionResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para response de predicciÃ³n.&quot;&quot;&quot;</span>
<a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a>
<a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a>    <span class=n>prediction</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;0=No churn, 1=Churn&quot;</span><span class=p>)</span>
<a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a>    <span class=n>probability</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Probabilidad de churn&quot;</span><span class=p>)</span>
<a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a>    <span class=n>risk_level</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&quot;low&quot;</span><span class=p>,</span> <span class=s2>&quot;medium&quot;</span><span class=p>,</span> <span class=s2>&quot;high&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Nivel de riesgo&quot;</span><span class=p>)</span>
<a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a>
<a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a>
<a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a><span class=k>class</span><span class=w> </span><span class=nc>HealthResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para health check.&quot;&quot;&quot;</span>
<a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a>
<a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a>    <span class=n>status</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&quot;healthy&quot;</span><span class=p>,</span> <span class=s2>&quot;degraded&quot;</span><span class=p>,</span> <span class=s2>&quot;unhealthy&quot;</span><span class=p>]</span>
<a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a>    <span class=n>model_loaded</span><span class=p>:</span> <span class=nb>bool</span>
<a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a>    <span class=n>version</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a>
<a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a>
<a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a><span class=k>class</span><span class=w> </span><span class=nc>BatchPredictionRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para predicciÃ³n en batch.&quot;&quot;&quot;</span>
<a id=__codelineno-5-64 name=__codelineno-5-64 href=#__codelineno-5-64></a>
<a id=__codelineno-5-65 name=__codelineno-5-65 href=#__codelineno-5-65></a>    <span class=n>customers</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>PredictionRequest</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
<a id=__codelineno-5-66 name=__codelineno-5-66 href=#__codelineno-5-66></a>        <span class=o>...</span><span class=p>,</span> 
<a id=__codelineno-5-67 name=__codelineno-5-67 href=#__codelineno-5-67></a>        <span class=n>min_items</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> 
<a id=__codelineno-5-68 name=__codelineno-5-68 href=#__codelineno-5-68></a>        <span class=n>max_items</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
<a id=__codelineno-5-69 name=__codelineno-5-69 href=#__codelineno-5-69></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Lista de clientes (mÃ¡x 1000)&quot;</span>
<a id=__codelineno-5-70 name=__codelineno-5-70 href=#__codelineno-5-70></a>    <span class=p>)</span>
<a id=__codelineno-5-71 name=__codelineno-5-71 href=#__codelineno-5-71></a>
<a id=__codelineno-5-72 name=__codelineno-5-72 href=#__codelineno-5-72></a>
<a id=__codelineno-5-73 name=__codelineno-5-73 href=#__codelineno-5-73></a><span class=k>class</span><span class=w> </span><span class=nc>BatchPredictionResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-5-74 name=__codelineno-5-74 href=#__codelineno-5-74></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para response de batch.&quot;&quot;&quot;</span>
<a id=__codelineno-5-75 name=__codelineno-5-75 href=#__codelineno-5-75></a>
<a id=__codelineno-5-76 name=__codelineno-5-76 href=#__codelineno-5-76></a>    <span class=n>predictions</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>PredictionResponse</span><span class=p>]</span>
<a id=__codelineno-5-77 name=__codelineno-5-77 href=#__codelineno-5-77></a>    <span class=n>processed</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-5-78 name=__codelineno-5-78 href=#__codelineno-5-78></a>    <span class=n>errors</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</code></pre></div> <hr> <p><a id=143-endpoints-de-prediccion></a></p> <h2 id=143-endpoints-de-prediccion>14.3 Endpoints de PredicciÃ³n<a class=headerlink href=#143-endpoints-de-prediccion title="Permanent link">&para;</a></h2> <h3 id=single-prediction>Single Prediction<a class=headerlink href=#single-prediction title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionResponse</span><span class=p>)</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictionRequest</span><span class=p>):</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=sd>    Predice probabilidad de churn para UN cliente.</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=sd>    - **CreditScore**: Score crediticio (300-850)</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=sd>    - **Geography**: PaÃ­s (France, Germany, Spain)</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=sd>    - **Gender**: GÃ©nero</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=sd>    - **Age**: Edad (18-100)</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=sd>    - ... etc</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=sd>    Returns:</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=sd>    - **prediction**: 0 (no churn) o 1 (churn)</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=sd>    - **probability**: Probabilidad [0, 1]</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=sd>    - **risk_level**: low/medium/high</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>            <span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> 
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>            <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Modelo no disponible. Reinicie el servicio.&quot;</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>        <span class=p>)</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>        <span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>request</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()])</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>        <span class=n>proba</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>df</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>        <span class=n>prediction</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.5</span><span class=p>)</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>        <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.7</span><span class=p>:</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>            <span class=n>risk</span> <span class=o>=</span> <span class=s2>&quot;high&quot;</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>        <span class=k>elif</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.3</span><span class=p>:</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a>            <span class=n>risk</span> <span class=o>=</span> <span class=s2>&quot;medium&quot;</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a>            <span class=n>risk</span> <span class=o>=</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a>
<a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a>        <span class=k>return</span> <span class=n>PredictionResponse</span><span class=p>(</span>
<a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a>            <span class=n>prediction</span><span class=o>=</span><span class=n>prediction</span><span class=p>,</span>
<a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a>            <span class=n>probability</span><span class=o>=</span><span class=nb>round</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>proba</span><span class=p>),</span> <span class=mi>4</span><span class=p>),</span>
<a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a>            <span class=n>risk_level</span><span class=o>=</span><span class=n>risk</span>
<a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a>        <span class=p>)</span>
<a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a>
<a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Error en predicciÃ³n: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=batch-prediction>Batch Prediction<a class=headerlink href=#batch-prediction title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict/batch&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>BatchPredictionResponse</span><span class=p>)</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict_batch</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>BatchPredictionRequest</span><span class=p>):</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=sd>    Predice churn para mÃºltiples clientes (mÃ¡x 1000).</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=sd>    Ãštil para scoring masivo de cartera.</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Modelo no disponible&quot;</span><span class=p>)</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>    <span class=n>errors</span> <span class=o>=</span> <span class=mi>0</span>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>    <span class=c1># Convertir todos los requests a DataFrame (mÃ¡s eficiente)</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>    <span class=n>data</span> <span class=o>=</span> <span class=p>[</span><span class=n>c</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>request</span><span class=o>.</span><span class=n>customers</span><span class=p>]</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>        <span class=n>probas</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>df</span><span class=p>)[:,</span> <span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>        <span class=k>for</span> <span class=n>proba</span> <span class=ow>in</span> <span class=n>probas</span><span class=p>:</span>
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>            <span class=n>prediction</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.5</span><span class=p>)</span>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>            <span class=n>risk</span> <span class=o>=</span> <span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;medium&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.3</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>
<a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>PredictionResponse</span><span class=p>(</span>
<a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>                <span class=n>prediction</span><span class=o>=</span><span class=n>prediction</span><span class=p>,</span>
<a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>                <span class=n>probability</span><span class=o>=</span><span class=nb>round</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=n>proba</span><span class=p>),</span> <span class=mi>4</span><span class=p>),</span>
<a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>                <span class=n>risk_level</span><span class=o>=</span><span class=n>risk</span>
<a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>            <span class=p>))</span>
<a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>
<a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Error en batch: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>
<a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>    <span class=k>return</span> <span class=n>BatchPredictionResponse</span><span class=p>(</span>
<a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a>        <span class=n>predictions</span><span class=o>=</span><span class=n>results</span><span class=p>,</span>
<a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>        <span class=n>processed</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>),</span>
<a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>        <span class=n>errors</span><span class=o>=</span><span class=n>errors</span>
<a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a>    <span class=p>)</span>
</code></pre></div> <hr> <p><a id=144-error-handling></a></p> <h2 id=144-error-handling>14.4 Error Handling<a class=headerlink href=#144-error-handling title="Permanent link">&para;</a></h2> <h3 id=custom-exception-handlers>Custom Exception Handlers<a class=headerlink href=#custom-exception-handlers title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>Request</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi.responses</span><span class=w> </span><span class=kn>import</span> <span class=n>JSONResponse</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=k>class</span><span class=w> </span><span class=nc>ModelNotLoadedError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Modelo no cargado.&quot;&quot;&quot;</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    <span class=k>pass</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=k>class</span><span class=w> </span><span class=nc>InvalidInputError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Input invÃ¡lido.&quot;&quot;&quot;</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    <span class=k>pass</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=nd>@app</span><span class=o>.</span><span class=n>exception_handler</span><span class=p>(</span><span class=n>ModelNotLoadedError</span><span class=p>)</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>model_not_loaded_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>exc</span><span class=p>:</span> <span class=n>ModelNotLoadedError</span><span class=p>):</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>    <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>        <span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>        <span class=n>content</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>            <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;service_unavailable&quot;</span><span class=p>,</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>            <span class=s2>&quot;message&quot;</span><span class=p>:</span> <span class=s2>&quot;El modelo no estÃ¡ cargado. Intente mÃ¡s tarde.&quot;</span><span class=p>,</span>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>            <span class=s2>&quot;retry_after&quot;</span><span class=p>:</span> <span class=mi>30</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>        <span class=p>}</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>    <span class=p>)</span>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=nd>@app</span><span class=o>.</span><span class=n>exception_handler</span><span class=p>(</span><span class=n>InvalidInputError</span><span class=p>)</span>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>invalid_input_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>exc</span><span class=p>:</span> <span class=n>InvalidInputError</span><span class=p>):</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>    <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>        <span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>        <span class=n>content</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>            <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;invalid_input&quot;</span><span class=p>,</span>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>            <span class=s2>&quot;message&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>exc</span><span class=p>),</span>
<a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>            <span class=s2>&quot;hint&quot;</span><span class=p>:</span> <span class=s2>&quot;Verifique que todos los campos tengan valores vÃ¡lidos&quot;</span>
<a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>        <span class=p>}</span>
<a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>    <span class=p>)</span>
<a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>
<a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>
<a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a><span class=c1># Catch-all para errores no manejados</span>
<a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a><span class=nd>@app</span><span class=o>.</span><span class=n>exception_handler</span><span class=p>(</span><span class=ne>Exception</span><span class=p>)</span>
<a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>generic_exception_handler</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>exc</span><span class=p>:</span> <span class=ne>Exception</span><span class=p>):</span>
<a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a>    <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span>
<a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a>        <span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
<a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>        <span class=n>content</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a>            <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;internal_error&quot;</span><span class=p>,</span>
<a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>            <span class=s2>&quot;message&quot;</span><span class=p>:</span> <span class=s2>&quot;Error interno del servidor&quot;</span><span class=p>,</span>
<a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a>            <span class=s2>&quot;detail&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>exc</span><span class=p>)</span> <span class=k>if</span> <span class=n>app</span><span class=o>.</span><span class=n>debug</span> <span class=k>else</span> <span class=kc>None</span>
<a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>        <span class=p>}</span>
<a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>    <span class=p>)</span>
</code></pre></div> <hr> <p><a id=145-codigo-real-del-portafolio></a></p> <h2 id=145-codigo-real-del-portafolio>14.5 CÃ³digo Real del Portafolio<a class=headerlink href=#145-codigo-real-del-portafolio title="Permanent link">&para;</a></h2> <h3 id=appfastapi_apppy-bankchurn-simplificado>app/fastapi_app.py (BankChurn - Simplificado)<a class=headerlink href=#appfastapi_apppy-bankchurn-simplificado title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=sd>&quot;&quot;&quot;FastAPI application for BankChurn prediction service.&quot;&quot;&quot;</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=kn>from</span><span class=w> </span><span class=nn>__future__</span><span class=w> </span><span class=kn>import</span> <span class=n>annotations</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=kn>import</span><span class=w> </span><span class=nn>logging</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=kn>import</span><span class=w> </span><span class=nn>os</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=kn>from</span><span class=w> </span><span class=nn>contextlib</span><span class=w> </span><span class=kn>import</span> <span class=n>asynccontextmanager</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=kn>from</span><span class=w> </span><span class=nn>pathlib</span><span class=w> </span><span class=kn>import</span> <span class=n>Path</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Literal</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=kn>import</span><span class=w> </span><span class=nn>joblib</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=kn>import</span><span class=w> </span><span class=nn>pandas</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pd</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi.middleware.cors</span><span class=w> </span><span class=kn>import</span> <span class=n>CORSMiddleware</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=c1># SCHEMAS</span>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>
<a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=k>class</span><span class=w> </span><span class=nc>CustomerInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a>    <span class=n>CreditScore</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>850</span><span class=p>)</span>
<a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a>    <span class=n>Geography</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-9-26 name=__codelineno-9-26 href=#__codelineno-9-26></a>    <span class=n>Gender</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-9-27 name=__codelineno-9-27 href=#__codelineno-9-27></a>    <span class=n>Age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-9-28 name=__codelineno-9-28 href=#__codelineno-9-28></a>    <span class=n>Tenure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
<a id=__codelineno-9-29 name=__codelineno-9-29 href=#__codelineno-9-29></a>    <span class=n>Balance</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-9-30 name=__codelineno-9-30 href=#__codelineno-9-30></a>    <span class=n>NumOfProducts</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
<a id=__codelineno-9-31 name=__codelineno-9-31 href=#__codelineno-9-31></a>    <span class=n>HasCrCard</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-9-32 name=__codelineno-9-32 href=#__codelineno-9-32></a>    <span class=n>IsActiveMember</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
<a id=__codelineno-9-33 name=__codelineno-9-33 href=#__codelineno-9-33></a>    <span class=n>EstimatedSalary</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-9-34 name=__codelineno-9-34 href=#__codelineno-9-34></a>
<a id=__codelineno-9-35 name=__codelineno-9-35 href=#__codelineno-9-35></a>
<a id=__codelineno-9-36 name=__codelineno-9-36 href=#__codelineno-9-36></a><span class=k>class</span><span class=w> </span><span class=nc>PredictionOutput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-9-37 name=__codelineno-9-37 href=#__codelineno-9-37></a>    <span class=n>prediction</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-9-38 name=__codelineno-9-38 href=#__codelineno-9-38></a>    <span class=n>probability</span><span class=p>:</span> <span class=nb>float</span>
<a id=__codelineno-9-39 name=__codelineno-9-39 href=#__codelineno-9-39></a>    <span class=n>risk_level</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-9-40 name=__codelineno-9-40 href=#__codelineno-9-40></a>
<a id=__codelineno-9-41 name=__codelineno-9-41 href=#__codelineno-9-41></a>
<a id=__codelineno-9-42 name=__codelineno-9-42 href=#__codelineno-9-42></a><span class=k>class</span><span class=w> </span><span class=nc>HealthOutput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-9-43 name=__codelineno-9-43 href=#__codelineno-9-43></a>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-9-44 name=__codelineno-9-44 href=#__codelineno-9-44></a>    <span class=n>model_loaded</span><span class=p>:</span> <span class=nb>bool</span>
<a id=__codelineno-9-45 name=__codelineno-9-45 href=#__codelineno-9-45></a>
<a id=__codelineno-9-46 name=__codelineno-9-46 href=#__codelineno-9-46></a>
<a id=__codelineno-9-47 name=__codelineno-9-47 href=#__codelineno-9-47></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-9-48 name=__codelineno-9-48 href=#__codelineno-9-48></a><span class=c1># APP</span>
<a id=__codelineno-9-49 name=__codelineno-9-49 href=#__codelineno-9-49></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-9-50 name=__codelineno-9-50 href=#__codelineno-9-50></a>
<a id=__codelineno-9-51 name=__codelineno-9-51 href=#__codelineno-9-51></a><span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-9-52 name=__codelineno-9-52 href=#__codelineno-9-52></a>
<a id=__codelineno-9-53 name=__codelineno-9-53 href=#__codelineno-9-53></a><span class=nd>@asynccontextmanager</span>
<a id=__codelineno-9-54 name=__codelineno-9-54 href=#__codelineno-9-54></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>):</span>
<a id=__codelineno-9-55 name=__codelineno-9-55 href=#__codelineno-9-55></a>    <span class=k>global</span> <span class=n>model</span>
<a id=__codelineno-9-56 name=__codelineno-9-56 href=#__codelineno-9-56></a>
<a id=__codelineno-9-57 name=__codelineno-9-57 href=#__codelineno-9-57></a>    <span class=c1># Buscar modelo en varias ubicaciones</span>
<a id=__codelineno-9-58 name=__codelineno-9-58 href=#__codelineno-9-58></a>    <span class=n>paths</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-9-59 name=__codelineno-9-59 href=#__codelineno-9-59></a>        <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;models/model_v1.0.0.pkl&quot;</span><span class=p>),</span>
<a id=__codelineno-9-60 name=__codelineno-9-60 href=#__codelineno-9-60></a>        <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;artifacts/model.joblib&quot;</span><span class=p>),</span>
<a id=__codelineno-9-61 name=__codelineno-9-61 href=#__codelineno-9-61></a>        <span class=n>Path</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&quot;MODEL_PATH&quot;</span><span class=p>,</span> <span class=s2>&quot;model.joblib&quot;</span><span class=p>)),</span>
<a id=__codelineno-9-62 name=__codelineno-9-62 href=#__codelineno-9-62></a>    <span class=p>]</span>
<a id=__codelineno-9-63 name=__codelineno-9-63 href=#__codelineno-9-63></a>
<a id=__codelineno-9-64 name=__codelineno-9-64 href=#__codelineno-9-64></a>    <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>paths</span><span class=p>:</span>
<a id=__codelineno-9-65 name=__codelineno-9-65 href=#__codelineno-9-65></a>        <span class=k>if</span> <span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
<a id=__codelineno-9-66 name=__codelineno-9-66 href=#__codelineno-9-66></a>            <span class=n>model</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
<a id=__codelineno-9-67 name=__codelineno-9-67 href=#__codelineno-9-67></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Modelo cargado: </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-9-68 name=__codelineno-9-68 href=#__codelineno-9-68></a>            <span class=k>break</span>
<a id=__codelineno-9-69 name=__codelineno-9-69 href=#__codelineno-9-69></a>
<a id=__codelineno-9-70 name=__codelineno-9-70 href=#__codelineno-9-70></a>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-9-71 name=__codelineno-9-71 href=#__codelineno-9-71></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;âš ï¸ NingÃºn modelo encontrado&quot;</span><span class=p>)</span>
<a id=__codelineno-9-72 name=__codelineno-9-72 href=#__codelineno-9-72></a>
<a id=__codelineno-9-73 name=__codelineno-9-73 href=#__codelineno-9-73></a>    <span class=k>yield</span>
<a id=__codelineno-9-74 name=__codelineno-9-74 href=#__codelineno-9-74></a>    <span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-9-75 name=__codelineno-9-75 href=#__codelineno-9-75></a>
<a id=__codelineno-9-76 name=__codelineno-9-76 href=#__codelineno-9-76></a>
<a id=__codelineno-9-77 name=__codelineno-9-77 href=#__codelineno-9-77></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>
<a id=__codelineno-9-78 name=__codelineno-9-78 href=#__codelineno-9-78></a>    <span class=n>title</span><span class=o>=</span><span class=s2>&quot;BankChurn Predictor&quot;</span><span class=p>,</span>
<a id=__codelineno-9-79 name=__codelineno-9-79 href=#__codelineno-9-79></a>    <span class=n>version</span><span class=o>=</span><span class=s2>&quot;1.0.0&quot;</span><span class=p>,</span>
<a id=__codelineno-9-80 name=__codelineno-9-80 href=#__codelineno-9-80></a>    <span class=n>lifespan</span><span class=o>=</span><span class=n>lifespan</span>
<a id=__codelineno-9-81 name=__codelineno-9-81 href=#__codelineno-9-81></a><span class=p>)</span>
<a id=__codelineno-9-82 name=__codelineno-9-82 href=#__codelineno-9-82></a>
<a id=__codelineno-9-83 name=__codelineno-9-83 href=#__codelineno-9-83></a><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span>
<a id=__codelineno-9-84 name=__codelineno-9-84 href=#__codelineno-9-84></a>    <span class=n>CORSMiddleware</span><span class=p>,</span>
<a id=__codelineno-9-85 name=__codelineno-9-85 href=#__codelineno-9-85></a>    <span class=n>allow_origins</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>
<a id=__codelineno-9-86 name=__codelineno-9-86 href=#__codelineno-9-86></a>    <span class=n>allow_methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>
<a id=__codelineno-9-87 name=__codelineno-9-87 href=#__codelineno-9-87></a>    <span class=n>allow_headers</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;*&quot;</span><span class=p>],</span>
<a id=__codelineno-9-88 name=__codelineno-9-88 href=#__codelineno-9-88></a><span class=p>)</span>
<a id=__codelineno-9-89 name=__codelineno-9-89 href=#__codelineno-9-89></a>
<a id=__codelineno-9-90 name=__codelineno-9-90 href=#__codelineno-9-90></a>
<a id=__codelineno-9-91 name=__codelineno-9-91 href=#__codelineno-9-91></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>HealthOutput</span><span class=p>)</span>
<a id=__codelineno-9-92 name=__codelineno-9-92 href=#__codelineno-9-92></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>health</span><span class=p>():</span>
<a id=__codelineno-9-93 name=__codelineno-9-93 href=#__codelineno-9-93></a>    <span class=k>return</span> <span class=n>HealthOutput</span><span class=p>(</span>
<a id=__codelineno-9-94 name=__codelineno-9-94 href=#__codelineno-9-94></a>        <span class=n>status</span><span class=o>=</span><span class=s2>&quot;healthy&quot;</span> <span class=k>if</span> <span class=n>model</span> <span class=k>else</span> <span class=s2>&quot;degraded&quot;</span><span class=p>,</span>
<a id=__codelineno-9-95 name=__codelineno-9-95 href=#__codelineno-9-95></a>        <span class=n>model_loaded</span><span class=o>=</span><span class=n>model</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a id=__codelineno-9-96 name=__codelineno-9-96 href=#__codelineno-9-96></a>    <span class=p>)</span>
<a id=__codelineno-9-97 name=__codelineno-9-97 href=#__codelineno-9-97></a>
<a id=__codelineno-9-98 name=__codelineno-9-98 href=#__codelineno-9-98></a>
<a id=__codelineno-9-99 name=__codelineno-9-99 href=#__codelineno-9-99></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionOutput</span><span class=p>)</span>
<a id=__codelineno-9-100 name=__codelineno-9-100 href=#__codelineno-9-100></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>customer</span><span class=p>:</span> <span class=n>CustomerInput</span><span class=p>):</span>
<a id=__codelineno-9-101 name=__codelineno-9-101 href=#__codelineno-9-101></a>    <span class=k>if</span> <span class=n>model</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-9-102 name=__codelineno-9-102 href=#__codelineno-9-102></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>503</span><span class=p>,</span> <span class=s2>&quot;Modelo no disponible&quot;</span><span class=p>)</span>
<a id=__codelineno-9-103 name=__codelineno-9-103 href=#__codelineno-9-103></a>
<a id=__codelineno-9-104 name=__codelineno-9-104 href=#__codelineno-9-104></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>customer</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()])</span>
<a id=__codelineno-9-105 name=__codelineno-9-105 href=#__codelineno-9-105></a>    <span class=n>proba</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>df</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-9-106 name=__codelineno-9-106 href=#__codelineno-9-106></a>
<a id=__codelineno-9-107 name=__codelineno-9-107 href=#__codelineno-9-107></a>    <span class=k>return</span> <span class=n>PredictionOutput</span><span class=p>(</span>
<a id=__codelineno-9-108 name=__codelineno-9-108 href=#__codelineno-9-108></a>        <span class=n>prediction</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.5</span><span class=p>),</span>
<a id=__codelineno-9-109 name=__codelineno-9-109 href=#__codelineno-9-109></a>        <span class=n>probability</span><span class=o>=</span><span class=nb>round</span><span class=p>(</span><span class=n>proba</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
<a id=__codelineno-9-110 name=__codelineno-9-110 href=#__codelineno-9-110></a>        <span class=n>risk_level</span><span class=o>=</span><span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;medium&quot;</span> <span class=k>if</span> <span class=n>proba</span> <span class=o>&gt;=</span> <span class=mf>0.3</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-9-111 name=__codelineno-9-111 href=#__codelineno-9-111></a>    <span class=p>)</span>
<a id=__codelineno-9-112 name=__codelineno-9-112 href=#__codelineno-9-112></a>
<a id=__codelineno-9-113 name=__codelineno-9-113 href=#__codelineno-9-113></a>
<a id=__codelineno-9-114 name=__codelineno-9-114 href=#__codelineno-9-114></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
<a id=__codelineno-9-115 name=__codelineno-9-115 href=#__codelineno-9-115></a>    <span class=kn>import</span><span class=w> </span><span class=nn>uvicorn</span>
<a id=__codelineno-9-116 name=__codelineno-9-116 href=#__codelineno-9-116></a>    <span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>host</span><span class=o>=</span><span class=s2>&quot;0.0.0.0&quot;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</code></pre></div> <hr> <p><a id=146-ingenieria-inversa-fastapi></a></p> <h2 id=146-ingenieria-inversa-pedagogica-api-de-produccion-real>14.6 ğŸ”¬ IngenierÃ­a Inversa PedagÃ³gica: API de ProducciÃ³n Real<a class=headerlink href=#146-ingenieria-inversa-pedagogica-api-de-produccion-real title="Permanent link">&para;</a></h2> <blockquote> <p><strong>Objetivo</strong>: Entender CADA decisiÃ³n detrÃ¡s de la API FastAPI del portafolio.</p> </blockquote> <p>Esta secciÃ³n disecciona <code>app/fastapi_app.py</code> de BankChurn-Predictor, una API ML de producciÃ³n real.</p> <h3 id=1461-el-por-que-arquitectonico>14.6.1 ğŸ¯ El "Por QuÃ©" ArquitectÃ³nico<a class=headerlink href=#1461-el-por-que-arquitectonico title="Permanent link">&para;</a></h3> <p>Â¿Por quÃ© la API del portafolio estÃ¡ diseÃ±ada asÃ­?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>â”‚                    DECISIONES ARQUITECTÃ“NICAS DEL PORTAFOLIO                    â”‚
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>â”‚                                                                                 â”‚
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>â”‚  PROBLEMA 1: Â¿CÃ³mo cargo el modelo una sola vez sin bloquearlo en cada request? â”‚
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>â”‚  RIESGO: Cargar modelo (~500MB) en cada request = 2-5s de latencia              â”‚
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>â”‚  DECISIÃ“N: Cargar en `lifespan` (startup), guardar en variable global           â”‚
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>â”‚  RESULTADO: Primera carga ~3s, requests subsecuentes ~50ms                      â”‚
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>â”‚  REFERENCIA: fastapi_app.py lÃ­neas 100-107                                      â”‚
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>â”‚                                                                                 â”‚
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>â”‚  PROBLEMA 2: Â¿CÃ³mo valido inputs complejos (10+ features) sin cÃ³digo manual?    â”‚
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>â”‚  RIESGO: ValidaciÃ³n manual = bugs, inconsistencias, cÃ³digo repetido             â”‚
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>â”‚  DECISIÃ“N: Pydantic con Field validators para cada feature                      â”‚
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>â”‚  RESULTADO: ValidaciÃ³n automÃ¡tica, errores descriptivos, docs auto-generadas    â”‚
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>â”‚  REFERENCIA: fastapi_app.py lÃ­neas 128-155 (CustomerData)                       â”‚
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>â”‚                                                                                 â”‚
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>â”‚  PROBLEMA 3: Â¿CÃ³mo expongo mÃ©tricas para Prometheus sin acoplar el cÃ³digo?      â”‚
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a>â”‚  RIESGO: Sin mÃ©tricas = volar ciego en producciÃ³n                               â”‚
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>â”‚  DECISIÃ“N: prometheus_client con try/except (graceful degradation)              â”‚
<a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>â”‚  RESULTADO: MÃ©tricas si estÃ¡ disponible, fallback a JSON si no                  â”‚
<a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>â”‚  REFERENCIA: fastapi_app.py lÃ­neas 25-46, 284-297                               â”‚
<a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a>â”‚                                                                                 â”‚
<a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div> <h3 id=1462-anatomia-de-appfastapi_apppy>14.6.2 ğŸ” AnatomÃ­a de <code>app/fastapi_app.py</code><a class=headerlink href=#1462-anatomia-de-appfastapi_apppy title="Permanent link">&para;</a></h3> <p><strong>Archivo</strong>: <code>ML-MLOps-Portfolio/BankChurn-Predictor/app/fastapi_app.py</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=c1># BLOQUE 1: Importaciones con Graceful Degradation</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=k>try</span><span class=p>:</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=kn>from</span><span class=w> </span><span class=nn>prometheus_client</span><span class=w> </span><span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>generate_latest</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>    <span class=n>PROMETHEUS_AVAILABLE</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>    <span class=n>REQUEST_COUNT</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>        <span class=s2>&quot;bankchurn_requests_total&quot;</span><span class=p>,</span>        <span class=c1># Nombre de la mÃ©trica.</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>        <span class=s2>&quot;Total HTTP requests&quot;</span><span class=p>,</span>             <span class=c1># DescripciÃ³n.</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>        <span class=p>[</span><span class=s2>&quot;method&quot;</span><span class=p>,</span> <span class=s2>&quot;endpoint&quot;</span><span class=p>,</span> <span class=s2>&quot;status&quot;</span><span class=p>],</span>  <span class=c1># Labels para filtrar.</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>    <span class=p>)</span>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>    <span class=n>REQUEST_LATENCY</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>        <span class=s2>&quot;bankchurn_request_duration_seconds&quot;</span><span class=p>,</span>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>        <span class=s2>&quot;Request latency in seconds&quot;</span><span class=p>,</span>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>        <span class=p>[</span><span class=s2>&quot;endpoint&quot;</span><span class=p>],</span>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>        <span class=n>buckets</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.025</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>],</span>  <span class=c1># Buckets para percentiles.</span>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>    <span class=p>)</span>
<a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
<a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>    <span class=n>PROMETHEUS_AVAILABLE</span> <span class=o>=</span> <span class=kc>False</span>
<a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=c1># Â¿Por quÃ© try/except para mÃ©tricas?</span>
<a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=c1># - prometheus_client es opcional (puede no estar instalado en dev).</span>
<a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=c1># - La API sigue funcionando sin mÃ©tricas, pero las tiene si estÃ¡n disponibles.</span>
<a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=c1># - PatrÃ³n &quot;graceful degradation&quot;: funcionalidad reducida pero sin crash.</span>
<a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>
<a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=c1># BLOQUE 2: Lifecycle Management (Carga de Modelo)</span>
<a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=n>predictor</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ChurnPredictor</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>   <span class=c1># Variable global para el modelo.</span>
<a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a>
<a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=nd>@contextlib</span><span class=o>.</span><span class=n>asynccontextmanager</span>
<a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>):</span>
<a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Manage application lifecycle.&quot;&quot;&quot;</span>
<a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a>    <span class=k>global</span> <span class=n>predictor</span>
<a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a>    <span class=n>success</span> <span class=o>=</span> <span class=n>load_model_logic</span><span class=p>()</span>            <span class=c1># Carga modelo al iniciar.</span>
<a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>success</span><span class=p>:</span>
<a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;Application started without model loaded.&quot;</span><span class=p>)</span>
<a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a>        <span class=c1># NO crashea la app. Endpoint /predict devolverÃ¡ 503.</span>
<a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a>    <span class=k>yield</span>                                    <span class=c1># App corriendo.</span>
<a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a>    <span class=c1># Cleanup al cerrar (opcional).</span>
<a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a><span class=c1># Â¿Por quÃ© lifespan y no @app.on_event(&quot;startup&quot;)?</span>
<a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a><span class=c1># - on_event estÃ¡ deprecated en FastAPI &gt;= 0.93.</span>
<a id=__codelineno-11-43 name=__codelineno-11-43 href=#__codelineno-11-43></a><span class=c1># - lifespan es el patrÃ³n moderno recomendado.</span>
<a id=__codelineno-11-44 name=__codelineno-11-44 href=#__codelineno-11-44></a><span class=c1># - Permite cleanup al cerrar (conexiones DB, etc.).</span>
<a id=__codelineno-11-45 name=__codelineno-11-45 href=#__codelineno-11-45></a>
<a id=__codelineno-11-46 name=__codelineno-11-46 href=#__codelineno-11-46></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-47 name=__codelineno-11-47 href=#__codelineno-11-47></a><span class=c1># BLOQUE 3: Schemas Pydantic con ValidaciÃ³n Estricta</span>
<a id=__codelineno-11-48 name=__codelineno-11-48 href=#__codelineno-11-48></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-49 name=__codelineno-11-49 href=#__codelineno-11-49></a><span class=k>class</span><span class=w> </span><span class=nc>CustomerData</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-11-50 name=__codelineno-11-50 href=#__codelineno-11-50></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema para datos de cliente.&quot;&quot;&quot;</span>
<a id=__codelineno-11-51 name=__codelineno-11-51 href=#__codelineno-11-51></a>
<a id=__codelineno-11-52 name=__codelineno-11-52 href=#__codelineno-11-52></a>    <span class=n>CreditScore</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>850</span><span class=p>)</span>  <span class=c1># ...: required. ge/le: rangos.</span>
<a id=__codelineno-11-53 name=__codelineno-11-53 href=#__codelineno-11-53></a>    <span class=n>Geography</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
<a id=__codelineno-11-54 name=__codelineno-11-54 href=#__codelineno-11-54></a>    <span class=n>Gender</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
<a id=__codelineno-11-55 name=__codelineno-11-55 href=#__codelineno-11-55></a>    <span class=n>Age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-11-56 name=__codelineno-11-56 href=#__codelineno-11-56></a>    <span class=n>Balance</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-11-57 name=__codelineno-11-57 href=#__codelineno-11-57></a>    <span class=c1># ... mÃ¡s campos ...</span>
<a id=__codelineno-11-58 name=__codelineno-11-58 href=#__codelineno-11-58></a>
<a id=__codelineno-11-59 name=__codelineno-11-59 href=#__codelineno-11-59></a>    <span class=nd>@validator</span><span class=p>(</span><span class=s2>&quot;Geography&quot;</span><span class=p>)</span>
<a id=__codelineno-11-60 name=__codelineno-11-60 href=#__codelineno-11-60></a>    <span class=k>def</span><span class=w> </span><span class=nf>validate_geography</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
<a id=__codelineno-11-61 name=__codelineno-11-61 href=#__codelineno-11-61></a>        <span class=n>valid</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;France&quot;</span><span class=p>,</span> <span class=s2>&quot;Spain&quot;</span><span class=p>,</span> <span class=s2>&quot;Germany&quot;</span><span class=p>]</span>
<a id=__codelineno-11-62 name=__codelineno-11-62 href=#__codelineno-11-62></a>        <span class=k>if</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>valid</span><span class=p>:</span>
<a id=__codelineno-11-63 name=__codelineno-11-63 href=#__codelineno-11-63></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Geography must be one of: </span><span class=si>{</span><span class=n>valid</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-11-64 name=__codelineno-11-64 href=#__codelineno-11-64></a>        <span class=k>return</span> <span class=n>v</span>
<a id=__codelineno-11-65 name=__codelineno-11-65 href=#__codelineno-11-65></a><span class=c1># Â¿Por quÃ© validators personalizados?</span>
<a id=__codelineno-11-66 name=__codelineno-11-66 href=#__codelineno-11-66></a><span class=c1># - Field solo valida tipos y rangos numÃ©ricos.</span>
<a id=__codelineno-11-67 name=__codelineno-11-67 href=#__codelineno-11-67></a><span class=c1># - @validator permite validaciÃ³n de dominio (paÃ­ses vÃ¡lidos, formatos, etc.).</span>
<a id=__codelineno-11-68 name=__codelineno-11-68 href=#__codelineno-11-68></a><span class=c1># - Error messages claros para el consumidor de la API.</span>
<a id=__codelineno-11-69 name=__codelineno-11-69 href=#__codelineno-11-69></a>
<a id=__codelineno-11-70 name=__codelineno-11-70 href=#__codelineno-11-70></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-71 name=__codelineno-11-71 href=#__codelineno-11-71></a><span class=c1># BLOQUE 4: Endpoint /health (Liveness + Readiness)</span>
<a id=__codelineno-11-72 name=__codelineno-11-72 href=#__codelineno-11-72></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-73 name=__codelineno-11-73 href=#__codelineno-11-73></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>HealthResponse</span><span class=p>)</span>
<a id=__codelineno-11-74 name=__codelineno-11-74 href=#__codelineno-11-74></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>health_check</span><span class=p>():</span>
<a id=__codelineno-11-75 name=__codelineno-11-75 href=#__codelineno-11-75></a>    <span class=n>uptime</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
<a id=__codelineno-11-76 name=__codelineno-11-76 href=#__codelineno-11-76></a>    <span class=k>return</span> <span class=n>HealthResponse</span><span class=p>(</span>
<a id=__codelineno-11-77 name=__codelineno-11-77 href=#__codelineno-11-77></a>        <span class=n>status</span><span class=o>=</span><span class=s2>&quot;healthy&quot;</span> <span class=k>if</span> <span class=n>predictor</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=k>else</span> <span class=s2>&quot;degraded&quot;</span><span class=p>,</span>
<a id=__codelineno-11-78 name=__codelineno-11-78 href=#__codelineno-11-78></a>        <span class=n>model_loaded</span><span class=o>=</span><span class=n>predictor</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># Kubernetes readiness check usa esto.</span>
<a id=__codelineno-11-79 name=__codelineno-11-79 href=#__codelineno-11-79></a>        <span class=n>uptime_seconds</span><span class=o>=</span><span class=n>uptime</span><span class=p>,</span>
<a id=__codelineno-11-80 name=__codelineno-11-80 href=#__codelineno-11-80></a>        <span class=n>version</span><span class=o>=</span><span class=s2>&quot;1.0.0&quot;</span><span class=p>,</span>
<a id=__codelineno-11-81 name=__codelineno-11-81 href=#__codelineno-11-81></a>    <span class=p>)</span>
<a id=__codelineno-11-82 name=__codelineno-11-82 href=#__codelineno-11-82></a><span class=c1># Â¿Por quÃ© &quot;degraded&quot; en lugar de &quot;unhealthy&quot;?</span>
<a id=__codelineno-11-83 name=__codelineno-11-83 href=#__codelineno-11-83></a><span class=c1># - &quot;unhealthy&quot; harÃ­a que K8s mate el pod (liveness fail).</span>
<a id=__codelineno-11-84 name=__codelineno-11-84 href=#__codelineno-11-84></a><span class=c1># - &quot;degraded&quot; indica que funciona pero con capacidad reducida.</span>
<a id=__codelineno-11-85 name=__codelineno-11-85 href=#__codelineno-11-85></a><span class=c1># - El pod sigue vivo, el equipo puede investigar.</span>
<a id=__codelineno-11-86 name=__codelineno-11-86 href=#__codelineno-11-86></a>
<a id=__codelineno-11-87 name=__codelineno-11-87 href=#__codelineno-11-87></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-88 name=__codelineno-11-88 href=#__codelineno-11-88></a><span class=c1># BLOQUE 5: Endpoint /predict con MÃ©tricas</span>
<a id=__codelineno-11-89 name=__codelineno-11-89 href=#__codelineno-11-89></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-90 name=__codelineno-11-90 href=#__codelineno-11-90></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionResponse</span><span class=p>)</span>
<a id=__codelineno-11-91 name=__codelineno-11-91 href=#__codelineno-11-91></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict_churn</span><span class=p>(</span><span class=n>customer</span><span class=p>:</span> <span class=n>CustomerData</span><span class=p>):</span>
<a id=__codelineno-11-92 name=__codelineno-11-92 href=#__codelineno-11-92></a>    <span class=k>if</span> <span class=n>predictor</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-11-93 name=__codelineno-11-93 href=#__codelineno-11-93></a>        <span class=k>if</span> <span class=n>PROMETHEUS_AVAILABLE</span><span class=p>:</span>
<a id=__codelineno-11-94 name=__codelineno-11-94 href=#__codelineno-11-94></a>            <span class=n>REQUEST_COUNT</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&quot;POST&quot;</span><span class=p>,</span> <span class=n>endpoint</span><span class=o>=</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&quot;503&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
<a id=__codelineno-11-95 name=__codelineno-11-95 href=#__codelineno-11-95></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&quot;Model not available&quot;</span><span class=p>)</span>
<a id=__codelineno-11-96 name=__codelineno-11-96 href=#__codelineno-11-96></a>
<a id=__codelineno-11-97 name=__codelineno-11-97 href=#__codelineno-11-97></a>    <span class=n>start_pred</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-11-98 name=__codelineno-11-98 href=#__codelineno-11-98></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-11-99 name=__codelineno-11-99 href=#__codelineno-11-99></a>        <span class=n>customer_dict</span> <span class=o>=</span> <span class=n>customer</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>      <span class=c1># Pydantic model â†’ dict.</span>
<a id=__codelineno-11-100 name=__codelineno-11-100 href=#__codelineno-11-100></a>        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>customer_dict</span><span class=p>])</span>   <span class=c1># dict â†’ DataFrame (1 fila).</span>
<a id=__codelineno-11-101 name=__codelineno-11-101 href=#__codelineno-11-101></a>
<a id=__codelineno-11-102 name=__codelineno-11-102 href=#__codelineno-11-102></a>        <span class=n>results</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>include_proba</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-11-103 name=__codelineno-11-103 href=#__codelineno-11-103></a>
<a id=__codelineno-11-104 name=__codelineno-11-104 href=#__codelineno-11-104></a>        <span class=n>prob</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>results</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;probability&quot;</span><span class=p>])</span>  <span class=c1># float() evita numpy.float64.</span>
<a id=__codelineno-11-105 name=__codelineno-11-105 href=#__codelineno-11-105></a>        <span class=n>pred</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>results</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s2>&quot;prediction&quot;</span><span class=p>])</span>     <span class=c1># int() evita numpy.int64.</span>
<a id=__codelineno-11-106 name=__codelineno-11-106 href=#__codelineno-11-106></a>
<a id=__codelineno-11-107 name=__codelineno-11-107 href=#__codelineno-11-107></a>        <span class=n>pred_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_pred</span>
<a id=__codelineno-11-108 name=__codelineno-11-108 href=#__codelineno-11-108></a>
<a id=__codelineno-11-109 name=__codelineno-11-109 href=#__codelineno-11-109></a>        <span class=c1># Track metrics</span>
<a id=__codelineno-11-110 name=__codelineno-11-110 href=#__codelineno-11-110></a>        <span class=k>if</span> <span class=n>PROMETHEUS_AVAILABLE</span><span class=p>:</span>
<a id=__codelineno-11-111 name=__codelineno-11-111 href=#__codelineno-11-111></a>            <span class=n>REQUEST_COUNT</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>method</span><span class=o>=</span><span class=s2>&quot;POST&quot;</span><span class=p>,</span> <span class=n>endpoint</span><span class=o>=</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&quot;200&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
<a id=__codelineno-11-112 name=__codelineno-11-112 href=#__codelineno-11-112></a>            <span class=n>REQUEST_LATENCY</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>endpoint</span><span class=o>=</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>observe</span><span class=p>(</span><span class=n>pred_time</span><span class=p>)</span>
<a id=__codelineno-11-113 name=__codelineno-11-113 href=#__codelineno-11-113></a>
<a id=__codelineno-11-114 name=__codelineno-11-114 href=#__codelineno-11-114></a>        <span class=k>return</span> <span class=n>PredictionResponse</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
<a id=__codelineno-11-115 name=__codelineno-11-115 href=#__codelineno-11-115></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-11-116 name=__codelineno-11-116 href=#__codelineno-11-116></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Prediction error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-11-117 name=__codelineno-11-117 href=#__codelineno-11-117></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-11-118 name=__codelineno-11-118 href=#__codelineno-11-118></a><span class=c1># Â¿Por quÃ© float() y int() explÃ­citos?</span>
<a id=__codelineno-11-119 name=__codelineno-11-119 href=#__codelineno-11-119></a><span class=c1># - numpy.float64 no es JSON-serializable directamente.</span>
<a id=__codelineno-11-120 name=__codelineno-11-120 href=#__codelineno-11-120></a><span class=c1># - FastAPI/Pydantic pueden fallar al serializar tipos numpy.</span>
<a id=__codelineno-11-121 name=__codelineno-11-121 href=#__codelineno-11-121></a><span class=c1># - Convertir a tipos nativos de Python evita &quot;Object of type float64 is not JSON serializable&quot;.</span>
<a id=__codelineno-11-122 name=__codelineno-11-122 href=#__codelineno-11-122></a>
<a id=__codelineno-11-123 name=__codelineno-11-123 href=#__codelineno-11-123></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-124 name=__codelineno-11-124 href=#__codelineno-11-124></a><span class=c1># BLOQUE 6: Endpoint /predict_batch (OptimizaciÃ³n para Volumen)</span>
<a id=__codelineno-11-125 name=__codelineno-11-125 href=#__codelineno-11-125></a><span class=c1># â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<a id=__codelineno-11-126 name=__codelineno-11-126 href=#__codelineno-11-126></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict_batch&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>BatchPredictionResponse</span><span class=p>)</span>
<a id=__codelineno-11-127 name=__codelineno-11-127 href=#__codelineno-11-127></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict_batch</span><span class=p>(</span><span class=n>batch_data</span><span class=p>:</span> <span class=n>BatchCustomerData</span><span class=p>):</span>
<a id=__codelineno-11-128 name=__codelineno-11-128 href=#__codelineno-11-128></a>    <span class=c1># Vectoriza predicciones para eficiencia.</span>
<a id=__codelineno-11-129 name=__codelineno-11-129 href=#__codelineno-11-129></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>c</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>batch_data</span><span class=o>.</span><span class=n>customers</span><span class=p>])</span>
<a id=__codelineno-11-130 name=__codelineno-11-130 href=#__codelineno-11-130></a>    <span class=n>results</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>include_proba</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># 1 llamada, N resultados.</span>
<a id=__codelineno-11-131 name=__codelineno-11-131 href=#__codelineno-11-131></a>    <span class=c1># ...</span>
<a id=__codelineno-11-132 name=__codelineno-11-132 href=#__codelineno-11-132></a><span class=c1># Â¿Por quÃ© endpoint separado para batch?</span>
<a id=__codelineno-11-133 name=__codelineno-11-133 href=#__codelineno-11-133></a><span class=c1># - 1 request con 1000 clientes es mÃ¡s eficiente que 1000 requests de 1.</span>
<a id=__codelineno-11-134 name=__codelineno-11-134 href=#__codelineno-11-134></a><span class=c1># - El modelo puede vectorizar (GPU/CPU SIMD) las predicciones.</span>
<a id=__codelineno-11-135 name=__codelineno-11-135 href=#__codelineno-11-135></a><span class=c1># - Menor overhead de red y serializaciÃ³n.</span>
</code></pre></div> <h3 id=1463-laboratorio-de-replicacion>14.6.3 ğŸ§ª Laboratorio de ReplicaciÃ³n<a class=headerlink href=#1463-laboratorio-de-replicacion title="Permanent link">&para;</a></h3> <p><strong>Tu misiÃ³n</strong>: Implementar tu propia API de predicciÃ³n con mÃ©tricas.</p> <ol> <li> <p><strong>Crea el schema de request</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># schemas.py</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>validator</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=k>class</span><span class=w> </span><span class=nc>CustomerRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=n>credit_score</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>850</span><span class=p>)</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>    <span class=c1># AÃ±ade mÃ¡s campos segÃºn tu modelo</span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>    <span class=nd>@validator</span><span class=p>(</span><span class=s2>&quot;credit_score&quot;</span><span class=p>)</span>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>    <span class=k>def</span><span class=w> </span><span class=nf>score_must_be_realistic</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>        <span class=k>if</span> <span class=n>v</span> <span class=o>&lt;</span> <span class=mi>300</span><span class=p>:</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Credit score too low&quot;</span><span class=p>)</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>        <span class=k>return</span> <span class=n>v</span>
</code></pre></div></p> </li> <li> <p><strong>Implementa el lifecycle</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># app.py</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=kn>from</span><span class=w> </span><span class=nn>contextlib</span><span class=w> </span><span class=kn>import</span> <span class=n>asynccontextmanager</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=nd>@asynccontextmanager</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>):</span>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>    <span class=k>global</span> <span class=n>model</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;models/best_model.pkl&quot;</span><span class=p>)</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>    <span class=k>yield</span>
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>    <span class=n>model</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># Cleanup</span>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>lifespan</span><span class=o>=</span><span class=n>lifespan</span><span class=p>)</span>
</code></pre></div></p> </li> <li> <p><strong>AÃ±ade mÃ©tricas Prometheus</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kn>from</span><span class=w> </span><span class=nn>prometheus_client</span><span class=w> </span><span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>generate_latest</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=n>PREDICTIONS</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=s2>&quot;predictions_total&quot;</span><span class=p>,</span> <span class=s2>&quot;Total predictions&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;result&quot;</span><span class=p>])</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>  <span class=c1># Endpoint POST para predicciones.</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>CustomerRequest</span><span class=p>):</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>    <span class=c1># ... predicciÃ³n ...</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>    <span class=n>PREDICTIONS</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>result</span><span class=o>=</span><span class=s2>&quot;churn&quot;</span> <span class=k>if</span> <span class=n>pred</span> <span class=o>==</span> <span class=mi>1</span> <span class=k>else</span> <span class=s2>&quot;no_churn&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;prediction&quot;</span><span class=p>:</span> <span class=n>pred</span><span class=p>}</span>
</code></pre></div></p> </li> </ol> <h3 id=1464-troubleshooting-preventivo>14.6.4 ğŸš¨ Troubleshooting Preventivo<a class=headerlink href=#1464-troubleshooting-preventivo title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>SÃ­ntoma</th> <th>Causa Probable</th> <th>SoluciÃ³n</th> </tr> </thead> <tbody> <tr> <td><strong>"Object of type float64 is not JSON serializable"</strong></td> <td>Retornas tipos numpy sin convertir</td> <td>Usa <code>float(value)</code>, <code>int(value)</code> antes de retornar.</td> </tr> <tr> <td><strong>503 "Model not available"</strong></td> <td>Modelo no se cargÃ³ en startup</td> <td>Verifica path del modelo y logs de startup.</td> </tr> <tr> <td><strong>422 Unprocessable Entity</strong></td> <td>Request no cumple schema Pydantic</td> <td>Revisa el error detallado en response body.</td> </tr> <tr> <td><strong>Latencia alta en /predict</strong></td> <td>Modelo se carga en cada request</td> <td>Mueve carga a <code>lifespan</code>, guarda en variable global.</td> </tr> <tr> <td><strong>MÃ©tricas no aparecen en /metrics</strong></td> <td>prometheus_client no instalado</td> <td><code>pip install prometheus_client</code> o verifica try/except.</td> </tr> </tbody> </table> <hr> <p><a id=errores-habituales></a></p> <h2 id=errores-habituales-y-como-depurarlos-en-fastapi-para-ml>ğŸ§¨ Errores habituales y cÃ³mo depurarlos en FastAPI para ML<a class=headerlink href=#errores-habituales-y-como-depurarlos-en-fastapi-para-ml title="Permanent link">&para;</a></h2> <p>FastAPI te da mucho â€œgratisâ€, pero en APIs de ML los fallos suelen venir de modelos no cargados, esquemas desalineados o problemas de tipos/serializaciÃ³n.</p> <p>Si alguno de estos errores te tomÃ³ <strong>&gt;15 minutos</strong>, regÃ­stralo en el <strong><a href=../study_tools/DIARIO_ERRORES/ >Diario de Errores</a></strong> y aplica el flujo de <strong>rescate cognitivo</strong> de <strong><a href=../study_tools/PROTOCOLO_E/ >Protocolo E</a></strong>.</p> <h3 id=1-el-modelo-no-se-carga-503-constantes>1) El modelo no se carga (503 constantes)<a class=headerlink href=#1-el-modelo-no-se-carga-503-constantes title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntomas tÃ­picos</strong></p> <ul> <li>El endpoint <code>/predict</code> responde <code>503 Modelo no disponible</code>.</li> <li>Logs con mensajes tipo <code>Modelo no encontrado</code> o <code>NingÃºn modelo encontrado</code>.</li> </ul> <p><strong>CÃ³mo identificarlo</strong></p> <ul> <li>Revisa la funciÃ³n <code>lifespan</code> o cÃ³digo de startup: Â¿la ruta del modelo (<code>models/</code>, <code>artifacts/</code>) existe dentro del contenedor?</li> <li>Comprueba variables de entorno como <code>MODEL_PATH</code>.</li> </ul> <p><strong>CÃ³mo corregirlo</strong></p> <ul> <li>Asegura rutas consistentes entre entrenamiento, Dockerfile y FastAPI.</li> <li>En local, imprime (<code>logger.info</code>) la ruta exacta desde la que intentas cargar y verifica que el archivo estÃ© ahÃ­.</li> </ul> <hr> <h3 id=2-esquema-pydantic-desalineado-con-el-pipeline>2) Esquema Pydantic desalineado con el pipeline<a class=headerlink href=#2-esquema-pydantic-desalineado-con-el-pipeline title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntomas tÃ­picos</strong></p> <ul> <li>Errores <code>KeyError</code> o <code>Column not found</code> al predecir.</li> <li>El modelo espera columnas con ciertos nombres pero el <code>PredictionRequest</code> usa otros.</li> </ul> <p><strong>CÃ³mo identificarlo</strong></p> <ul> <li>Compara los campos del schema (<code>CreditScore</code>, <code>Geography</code>, etc.) con las columnas que el pipeline de sklearn espera.</li> </ul> <p><strong>CÃ³mo corregirlo</strong></p> <ul> <li>Usa los <strong>mismos nombres de features</strong> que en el training pipeline.</li> <li>Si renombraste columnas en feature engineering, refleja esos cambios en el schema y en la transformaciÃ³n de entrada antes de llamar al modelo.</li> </ul> <hr> <h3 id=3-problemas-de-tipos-y-serializacion>3) Problemas de tipos y serializaciÃ³n<a class=headerlink href=#3-problemas-de-tipos-y-serializacion title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntomas tÃ­picos</strong></p> <ul> <li>Errores <code>TypeError: Object of type ... is not JSON serializable</code>.</li> <li>Respuestas con valores <code>NaN</code> o <code>Infinity</code> que rompen el cliente.</li> </ul> <p><strong>CÃ³mo identificarlo</strong></p> <ul> <li>Revisa el tipo real de lo que devuelves en <code>PredictionResponse</code> (por ejemplo, <code>numpy.float32</code> en vez de <code>float</code>).</li> </ul> <p><strong>CÃ³mo corregirlo</strong></p> <ul> <li>Convierte explÃ­citamente a tipos nativos de Python (<code>float</code>, <code>int</code>, <code>str</code>).</li> <li>AsegÃºrate de que no devuelves <code>NaN</code> o <code>inf</code> (redondea o reemplaza por valores vÃ¡lidos).</li> </ul> <hr> <h3 id=4-cors-o-healthcheck-mal-configurados>4) CORS o healthcheck mal configurados<a class=headerlink href=#4-cors-o-healthcheck-mal-configurados title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntomas tÃ­picos</strong></p> <ul> <li>El frontend no puede llamar al API por errores de CORS.</li> <li>Kubernetes/Compose marcan el servicio como unhealthy.</li> </ul> <p><strong>CÃ³mo identificarlo</strong></p> <ul> <li>Revisa configuraciÃ³n de <code>CORSMiddleware</code> y el endpoint <code>/health</code>.</li> </ul> <p><strong>CÃ³mo corregirlo</strong></p> <ul> <li>En desarrollo puedes usar <code>allow_origins=["*"]</code>, pero en producciÃ³n limita a tus dominios.</li> <li>Verifica que <code>/health</code> no dependa de modelos pesados para responder rÃ¡pido y con 200.</li> </ul> <hr> <h3 id=5-patron-general-de-debugging-en-apis-de-ml>5) PatrÃ³n general de debugging en APIs de ML<a class=headerlink href=#5-patron-general-de-debugging-en-apis-de-ml title="Permanent link">&para;</a></h3> <ol> <li>Llama al endpoint con <code>curl</code> o <code>httpie</code> usando el <code>example</code> del schema.</li> <li>Mira los logs del servidor (uvicorn) para ver tracebacks completos.</li> <li>Verifica rutas de modelo y variables de entorno que afectan al loading.</li> <li>AsegÃºrate de que lo que entra/sale del API coincide con lo que tu modelo entrenado espera.</li> </ol> <p>Con esta disciplina, tu API FastAPI pasarÃ¡ de â€œfunciona solo en localâ€ a estar lista para producciÃ³n.</p> <hr> <p><a id=ejercicio></a></p> <h2 id=ejercicio>âœ… Ejercicio<a class=headerlink href=#ejercicio title="Permanent link">&para;</a></h2> <ol> <li>Implementa <code>/predict/batch</code> para procesar mÃºltiples clientes</li> <li>AÃ±ade endpoint <code>/model/info</code> que retorne metadata del modelo</li> <li>Implementa rate limiting bÃ¡sico</li> </ol> <hr> <h2 id=como-se-uso-en-el-portafolio>ğŸ“¦ CÃ³mo se UsÃ³ en el Portafolio<a class=headerlink href=#como-se-uso-en-el-portafolio title="Permanent link">&para;</a></h2> <p>Cada proyecto tiene una API FastAPI en <code>app/fastapi_app.py</code>:</p> <h3 id=api-de-bankchurn>API de BankChurn<a class=headerlink href=#api-de-bankchurn title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1># BankChurn-Predictor/app/fastapi_app.py (estructura)</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&quot;BankChurn Predictor API&quot;</span><span class=p>)</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=k>class</span><span class=w> </span><span class=nc>PredictionRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>    <span class=n>CreditScore</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>    <span class=n>Geography</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>    <span class=n>Gender</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>    <span class=n>Age</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>    <span class=n>Balance</span><span class=p>:</span> <span class=nb>float</span>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>    <span class=c1># ... mÃ¡s features</span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=k>class</span><span class=w> </span><span class=nc>PredictionResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a>    <span class=n>prediction</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>    <span class=n>probability</span><span class=p>:</span> <span class=nb>float</span>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>    <span class=n>risk_level</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>)</span>  <span class=c1># Endpoint GET para health check.</span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>health</span><span class=p>():</span>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;healthy&quot;</span><span class=p>,</span> <span class=s2>&quot;model_loaded&quot;</span><span class=p>:</span> <span class=n>model</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>}</span>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionResponse</span><span class=p>)</span>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictionRequest</span><span class=p>):</span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a>    <span class=n>features</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>
<a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>features</span><span class=p>])</span>
<a id=__codelineno-15-28 name=__codelineno-15-28 href=#__codelineno-15-28></a>    <span class=n>prediction</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>df</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<a id=__codelineno-15-29 name=__codelineno-15-29 href=#__codelineno-15-29></a>    <span class=n>probability</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>df</span><span class=p>)[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-15-30 name=__codelineno-15-30 href=#__codelineno-15-30></a>    <span class=k>return</span> <span class=n>PredictionResponse</span><span class=p>(</span>
<a id=__codelineno-15-31 name=__codelineno-15-31 href=#__codelineno-15-31></a>        <span class=n>prediction</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>prediction</span><span class=p>),</span>
<a id=__codelineno-15-32 name=__codelineno-15-32 href=#__codelineno-15-32></a>        <span class=n>probability</span><span class=o>=</span><span class=nb>float</span><span class=p>(</span><span class=n>probability</span><span class=p>),</span>
<a id=__codelineno-15-33 name=__codelineno-15-33 href=#__codelineno-15-33></a>        <span class=n>risk_level</span><span class=o>=</span><span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>probability</span> <span class=o>&gt;</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-15-34 name=__codelineno-15-34 href=#__codelineno-15-34></a>    <span class=p>)</span>
</code></pre></div> <h3 id=apis-por-proyecto>APIs por Proyecto<a class=headerlink href=#apis-por-proyecto title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>Proyecto</th> <th>Endpoint Principal</th> <th>Tipo</th> </tr> </thead> <tbody> <tr> <td>BankChurn</td> <td><code>/predict</code></td> <td>ClasificaciÃ³n binaria</td> </tr> <tr> <td>CarVision</td> <td><code>/predict</code></td> <td>RegresiÃ³n</td> </tr> <tr> <td>TelecomAI</td> <td><code>/predict</code></td> <td>ClasificaciÃ³n multiclase</td> </tr> </tbody> </table> <h3 id=ejercicio-prueba-las-apis-reales>ğŸ”§ Ejercicio: Prueba las APIs Reales<a class=headerlink href=#ejercicio-prueba-las-apis-reales title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1># 1. Inicia API de BankChurn</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=nb>cd</span><span class=w> </span>BankChurn-Predictor
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>uvicorn<span class=w> </span>app.fastapi_app:app<span class=w> </span>--reload
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=c1># 2. Prueba con curl</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>curl<span class=w> </span>http://localhost:8000/health
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>curl<span class=w> </span>-X<span class=w> </span>POST<span class=w> </span>http://localhost:8000/predict<span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>  </span>-H<span class=w> </span><span class=s2>&quot;Content-Type: application/json&quot;</span><span class=w> </span><span class=se>\</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>  </span>-d<span class=w> </span><span class=s1>&#39;{&quot;CreditScore&quot;: 650, &quot;Geography&quot;: &quot;France&quot;, ...}&#39;</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=c1># 3. Ve docs interactivos</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=c1># http://localhost:8000/docs</span>
</code></pre></div> <hr> <p><a id=checkpoint></a></p> <h2 id=checkpoint>âœ… Checkpoint<a class=headerlink href=#checkpoint title="Permanent link">&para;</a></h2> <ul> <li>[ ] <code>/health</code> responde rÃ¡pido (no hace inferencia ni carga pesada)</li> <li>[ ] <code>/predict</code> valida request/response con Pydantic</li> <li>[ ] Devuelves tipos nativos (sin <code>numpy.float32</code>, sin <code>NaN/inf</code>)</li> <li>[ ] Errores esperables se manejan con <code>HTTPException</code> y cÃ³digos correctos</li> <li>[ ] <code>/docs</code> y <code>/openapi.json</code> son accesibles</li> </ul> <hr> <h2 id=consejos-profesionales>ğŸ’¼ Consejos Profesionales<a class=headerlink href=#consejos-profesionales title="Permanent link">&para;</a></h2> <blockquote> <p><strong>Recomendaciones para destacar en entrevistas y proyectos reales</strong></p> </blockquote> <h3 id=para-entrevistas>Para Entrevistas<a class=headerlink href=#para-entrevistas title="Permanent link">&para;</a></h3> <ol> <li> <p><strong>Pydantic + FastAPI</strong>: Explica cÃ³mo la validaciÃ³n automÃ¡tica reduce cÃ³digo.</p> </li> <li> <p><strong>Async vs Sync</strong>: CuÃ¡ndo usar cada uno (IO-bound vs CPU-bound).</p> </li> <li> <p><strong>OpenAPI/Swagger</strong>: DocumentaciÃ³n automÃ¡tica como feature de FastAPI.</p> </li> </ol> <h3 id=para-proyectos-reales>Para Proyectos Reales<a class=headerlink href=#para-proyectos-reales title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th>SituaciÃ³n</th> <th>Consejo</th> </tr> </thead> <tbody> <tr> <td>ML Serving</td> <td>Carga modelo en startup, no en cada request</td> </tr> <tr> <td>ValidaciÃ³n</td> <td>Usa Pydantic para input/output schemas</td> </tr> <tr> <td>Errores</td> <td>HTTPException con cÃ³digos y mensajes claros</td> </tr> <tr> <td>ProducciÃ³n</td> <td>Gunicorn + Uvicorn workers</td> </tr> </tbody> </table> <h3 id=endpoints-esenciales-para-ml>Endpoints Esenciales para ML<a class=headerlink href=#endpoints-esenciales-para-ml title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=o>/</span><span class=n>health</span>          <span class=err>â†’</span> <span class=n>Liveness</span> <span class=n>check</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=o>/</span><span class=n>ready</span>           <span class=err>â†’</span> <span class=n>Readiness</span> <span class=n>check</span> <span class=p>(</span><span class=n>modelo</span> <span class=n>cargado</span><span class=p>)</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=o>/</span><span class=n>predict</span>         <span class=err>â†’</span> <span class=n>Inferencia</span> <span class=n>principal</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=o>/</span><span class=n>predict</span><span class=o>/</span><span class=n>batch</span>   <span class=err>â†’</span> <span class=n>Inferencia</span> <span class=n>batch</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=o>/</span><span class=n>model</span><span class=o>/</span><span class=n>info</span>      <span class=err>â†’</span> <span class=n>VersiÃ³n</span><span class=p>,</span> <span class=n>mÃ©tricas</span><span class=p>,</span> <span class=n>metadata</span>
</code></pre></div> <hr> <h2 id=recursos-externos-del-modulo>ğŸ“º Recursos Externos del MÃ³dulo<a class=headerlink href=#recursos-externos-del-modulo title="Permanent link">&para;</a></h2> <blockquote> <p>ğŸ·ï¸ Sistema: ğŸ”´ Obligatorio | ğŸŸ¡ Recomendado | ğŸŸ¢ Complementario</p> </blockquote> <h3 id=videos>ğŸ¬ Videos<a class=headerlink href=#videos title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th style="text-align: center;">ğŸ·ï¸</th> <th style="text-align: left;">TÃ­tulo</th> <th style="text-align: left;">Canal</th> <th style="text-align: center;">DuraciÃ³n</th> <th style="text-align: left;">Link</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">ğŸ”´</td> <td style="text-align: left;"><strong>FastAPI Full Course</strong></td> <td style="text-align: left;">SebastiÃ¡n RamÃ­rez</td> <td style="text-align: center;">1h</td> <td style="text-align: left;"><a href="https://www.youtube.com/watch?v=0sOvCWFmrtA">YouTube</a></td> </tr> <tr> <td style="text-align: center;">ğŸ”´</td> <td style="text-align: left;"><strong>ML APIs with FastAPI</strong></td> <td style="text-align: left;">ArjanCodes</td> <td style="text-align: center;">30 min</td> <td style="text-align: left;"><a href="https://www.youtube.com/watch?v=kBIX3_cMHzE">YouTube</a></td> </tr> <tr> <td style="text-align: center;">ğŸŸ¡</td> <td style="text-align: left;"><strong>Pydantic V2 Tutorial</strong></td> <td style="text-align: left;">ArjanCodes</td> <td style="text-align: center;">25 min</td> <td style="text-align: left;"><a href="https://www.youtube.com/watch?v=502XOB0u8OY">YouTube</a></td> </tr> </tbody> </table> <h3 id=documentacion>ğŸ“„ DocumentaciÃ³n<a class=headerlink href=#documentacion title="Permanent link">&para;</a></h3> <table> <thead> <tr> <th style="text-align: center;">ğŸ·ï¸</th> <th style="text-align: left;">Recurso</th> <th style="text-align: left;">DescripciÃ³n</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">ğŸ”´</td> <td style="text-align: left;"><a href=https://fastapi.tiangolo.com/ >FastAPI Docs</a></td> <td style="text-align: left;">DocumentaciÃ³n oficial</td> </tr> <tr> <td style="text-align: center;">ğŸŸ¡</td> <td style="text-align: left;"><a href=https://docs.pydantic.dev/latest/ >Pydantic v2</a></td> <td style="text-align: left;">ValidaciÃ³n de datos</td> </tr> </tbody> </table> <hr> <h2 id=decision-tecnica-adr-004-fastapi>âš–ï¸ DecisiÃ³n TÃ©cnica: ADR-004 FastAPI<a class=headerlink href=#decision-tecnica-adr-004-fastapi title="Permanent link">&para;</a></h2> <p><strong>Contexto</strong>: Necesitamos framework para APIs de inferencia ML.</p> <p><strong>DecisiÃ³n</strong>: Usar FastAPI como framework para todas las APIs.</p> <p><strong>Alternativas Consideradas</strong>: - <strong>Flask</strong>: Simple pero sync, validaciÃ³n manual - <strong>Django REST</strong>: Overkill para microservicios ML - <strong>gRPC</strong>: MÃ¡s rÃ¡pido pero mÃ¡s complejo</p> <p><strong>Consecuencias</strong>: - âœ… ValidaciÃ³n automÃ¡tica con Pydantic - âœ… Docs OpenAPI auto-generadas - âœ… Async nativo para alto throughput - âŒ Framework relativamente nuevo</p> <hr> <h2 id=ejercicios-del-modulo>ğŸ”§ Ejercicios del MÃ³dulo<a class=headerlink href=#ejercicios-del-modulo title="Permanent link">&para;</a></h2> <h3 id=ejercicio-141-schemas-pydantic>Ejercicio 14.1: Schemas Pydantic<a class=headerlink href=#ejercicio-141-schemas-pydantic title="Permanent link">&para;</a></h3> <p><strong>Objetivo</strong>: Definir schemas de request/response. <strong>Dificultad</strong>: â­â­</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=c1># TU TAREA: Crear schemas para endpoint /predict</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=c1># Request: customer features</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=c1># Response: prediction + probability + model_version</span>
</code></pre></div> <details> <summary>ğŸ’¡ Ver soluciÃ³n</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Optional</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=k>class</span><span class=w> </span><span class=nc>PredictRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema de entrada para predicciÃ³n.&quot;&quot;&quot;</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>    <span class=n>credit_score</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>850</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Credit score&quot;</span><span class=p>)</span>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Customer age&quot;</span><span class=p>)</span>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>    <span class=n>tenure</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Years as customer&quot;</span><span class=p>)</span>
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>    <span class=n>balance</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Account balance&quot;</span><span class=p>)</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a>    <span class=n>num_products</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Number of products&quot;</span><span class=p>)</span>
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>    <span class=n>has_credit_card</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a>    <span class=n>is_active_member</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a>
<a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>    <span class=n>model_config</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>        <span class=s2>&quot;json_schema_extra&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a>            <span class=s2>&quot;examples&quot;</span><span class=p>:</span> <span class=p>[{</span>
<a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a>                <span class=s2>&quot;credit_score&quot;</span><span class=p>:</span> <span class=mi>650</span><span class=p>,</span>
<a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>                <span class=s2>&quot;age&quot;</span><span class=p>:</span> <span class=mi>35</span><span class=p>,</span>
<a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a>                <span class=s2>&quot;tenure&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
<a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a>                <span class=s2>&quot;balance&quot;</span><span class=p>:</span> <span class=mf>50000.0</span><span class=p>,</span>
<a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a>                <span class=s2>&quot;num_products&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
<a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a>                <span class=s2>&quot;has_credit_card&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a>                <span class=s2>&quot;is_active_member&quot;</span><span class=p>:</span> <span class=kc>True</span>
<a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a>            <span class=p>}]</span>
<a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a>        <span class=p>}</span>
<a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a>    <span class=p>}</span>
<a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a>
<a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=k>class</span><span class=w> </span><span class=nc>PredictResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Schema de salida para predicciÃ³n.&quot;&quot;&quot;</span>
<a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a>    <span class=n>prediction</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;0=No churn, 1=Churn&quot;</span><span class=p>)</span>
<a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a>    <span class=n>probability</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Churn probability&quot;</span><span class=p>)</span>
<a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a>    <span class=n>risk_level</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;low/medium/high&quot;</span><span class=p>)</span>
<a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a>    <span class=n>model_version</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Model version used&quot;</span><span class=p>)</span>
<a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a>
<a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a>    <span class=n>model_config</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a>        <span class=s2>&quot;json_schema_extra&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a>            <span class=s2>&quot;examples&quot;</span><span class=p>:</span> <span class=p>[{</span>
<a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a>                <span class=s2>&quot;prediction&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
<a id=__codelineno-19-39 name=__codelineno-19-39 href=#__codelineno-19-39></a>                <span class=s2>&quot;probability&quot;</span><span class=p>:</span> <span class=mf>0.73</span><span class=p>,</span>
<a id=__codelineno-19-40 name=__codelineno-19-40 href=#__codelineno-19-40></a>                <span class=s2>&quot;risk_level&quot;</span><span class=p>:</span> <span class=s2>&quot;high&quot;</span><span class=p>,</span>
<a id=__codelineno-19-41 name=__codelineno-19-41 href=#__codelineno-19-41></a>                <span class=s2>&quot;model_version&quot;</span><span class=p>:</span> <span class=s2>&quot;1.2.0&quot;</span>
<a id=__codelineno-19-42 name=__codelineno-19-42 href=#__codelineno-19-42></a>            <span class=p>}]</span>
<a id=__codelineno-19-43 name=__codelineno-19-43 href=#__codelineno-19-43></a>        <span class=p>}</span>
<a id=__codelineno-19-44 name=__codelineno-19-44 href=#__codelineno-19-44></a>    <span class=p>}</span>
</code></pre></div> </details> <hr> <h3 id=ejercicio-142-endpoint-completo>Ejercicio 14.2: Endpoint Completo<a class=headerlink href=#ejercicio-142-endpoint-completo title="Permanent link">&para;</a></h3> <p><strong>Objetivo</strong>: Implementar endpoint /predict con manejo de errores. <strong>Dificultad</strong>: â­â­â­</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1># TU TAREA: Implementar endpoint que:</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=c1># 1. Reciba PredictRequest validado</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=c1># 2. Cargue modelo (cached)</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=c1># 3. Haga predicciÃ³n</span>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=c1># 4. Devuelva PredictResponse</span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=c1># 5. Maneje errores apropiadamente</span>
</code></pre></div> <details> <summary>ğŸ’¡ Ver soluciÃ³n</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=kn>from</span><span class=w> </span><span class=nn>functools</span><span class=w> </span><span class=kn>import</span> <span class=n>lru_cache</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=kn>import</span><span class=w> </span><span class=nn>joblib</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&quot;Churn Prediction API&quot;</span><span class=p>)</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=nd>@lru_cache</span><span class=p>()</span>
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=k>def</span><span class=w> </span><span class=nf>load_model</span><span class=p>():</span>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Carga modelo una sola vez.&quot;&quot;&quot;</span>
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a>        <span class=k>return</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;artifacts/model.joblib&quot;</span><span class=p>)</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a>    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>        <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&quot;Model not found&quot;</span><span class=p>)</span>
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a>
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/health&quot;</span><span class=p>)</span>  <span class=c1># Endpoint GET para health check.</span>
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>health</span><span class=p>():</span>
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a>    <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;status&quot;</span><span class=p>:</span> <span class=s2>&quot;healthy&quot;</span><span class=p>}</span>  <span class=c1># Respuesta JSON indicando que el servicio estÃ¡ activo.</span>
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>
<a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictResponse</span><span class=p>)</span>
<a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictRequest</span><span class=p>):</span>
<a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Predice probabilidad de churn.&quot;&quot;&quot;</span>
<a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a>        <span class=n>model</span> <span class=o>=</span> <span class=n>load_model</span><span class=p>()</span>
<a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a>    <span class=k>except</span> <span class=ne>RuntimeError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a>
<a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a>    <span class=c1># Preparar features</span>
<a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a>    <span class=n>features</span> <span class=o>=</span> <span class=p>[[</span>
<a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a>        <span class=n>request</span><span class=o>.</span><span class=n>credit_score</span><span class=p>,</span>
<a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a>        <span class=n>request</span><span class=o>.</span><span class=n>age</span><span class=p>,</span>
<a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a>        <span class=n>request</span><span class=o>.</span><span class=n>tenure</span><span class=p>,</span>
<a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a>        <span class=n>request</span><span class=o>.</span><span class=n>balance</span><span class=p>,</span>
<a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a>        <span class=n>request</span><span class=o>.</span><span class=n>num_products</span><span class=p>,</span>
<a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>        <span class=nb>int</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>has_credit_card</span><span class=p>),</span>
<a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a>        <span class=nb>int</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>is_active_member</span><span class=p>)</span>
<a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a>    <span class=p>]]</span>
<a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a>
<a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a>        <span class=n>prediction</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>features</span><span class=p>)[</span><span class=mi>0</span><span class=p>])</span>
<a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a>        <span class=n>probability</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>features</span><span class=p>)[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Prediction error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a>
<a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a>    <span class=c1># Determinar nivel de riesgo</span>
<a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a>    <span class=n>risk_level</span> <span class=o>=</span> <span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>probability</span> <span class=o>&gt;</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;medium&quot;</span> <span class=k>if</span> <span class=n>probability</span> <span class=o>&gt;</span> <span class=mf>0.3</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a>
<a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a>    <span class=k>return</span> <span class=n>PredictResponse</span><span class=p>(</span>
<a id=__codelineno-21-48 name=__codelineno-21-48 href=#__codelineno-21-48></a>        <span class=n>prediction</span><span class=o>=</span><span class=n>prediction</span><span class=p>,</span>
<a id=__codelineno-21-49 name=__codelineno-21-49 href=#__codelineno-21-49></a>        <span class=n>probability</span><span class=o>=</span><span class=n>probability</span><span class=p>,</span>
<a id=__codelineno-21-50 name=__codelineno-21-50 href=#__codelineno-21-50></a>        <span class=n>risk_level</span><span class=o>=</span><span class=n>risk_level</span><span class=p>,</span>
<a id=__codelineno-21-51 name=__codelineno-21-51 href=#__codelineno-21-51></a>        <span class=n>model_version</span><span class=o>=</span><span class=s2>&quot;1.0.0&quot;</span>
<a id=__codelineno-21-52 name=__codelineno-21-52 href=#__codelineno-21-52></a>    <span class=p>)</span>
</code></pre></div> </details> <hr> <h2 id=glosario-del-modulo>ğŸ”— Glosario del MÃ³dulo<a class=headerlink href=#glosario-del-modulo title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th>TÃ©rmino</th> <th>DefiniciÃ³n</th> </tr> </thead> <tbody> <tr> <td><strong>FastAPI</strong></td> <td>Framework web async para APIs Python con validaciÃ³n automÃ¡tica</td> </tr> <tr> <td><strong>Pydantic</strong></td> <td>LibrerÃ­a de validaciÃ³n de datos usando type hints</td> </tr> <tr> <td><strong>OpenAPI</strong></td> <td>EspecificaciÃ³n estÃ¡ndar para documentar APIs (antes Swagger)</td> </tr> <tr> <td><strong>@lru_cache</strong></td> <td>Decorator para cachear resultados de funciones</td> </tr> </tbody> </table> <hr> <h2 id=la-trampa-errores-comunes-de-este-modulo>ğŸª¤ La Trampa â€” Errores Comunes de Este MÃ³dulo<a class=headerlink href=#la-trampa-errores-comunes-de-este-modulo title="Permanent link">&para;</a></h2> <h3 id=trampa-1-api-sin-validacion-de-entrada>Trampa 1: API sin validaciÃ³n de entrada<a class=headerlink href=#trampa-1-api-sin-validacion-de-entrada title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntoma</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>  <span class=c1># âŒ Acepta cualquier cosa</span>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>    <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&quot;features&quot;</span><span class=p>])</span>
</code></pre></div></p> <p><strong>SoluciÃ³n</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=k>class</span><span class=w> </span><span class=nc>PredictRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>    <span class=n>features</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>min_items</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>max_items</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictRequest</span><span class=p>):</span>  <span class=c1># âœ… Validado</span>
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>    <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>([</span><span class=n>request</span><span class=o>.</span><span class=n>features</span><span class=p>])</span>
</code></pre></div></p> <hr> <h3 id=trampa-2-modelo-cargado-en-cada-request>Trampa 2: Modelo cargado en cada request<a class=headerlink href=#trampa-2-modelo-cargado-en-cada-request title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntoma</strong>: API lenta porque carga el modelo en cada request.</p> <p><strong>SoluciÃ³n</strong>: <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=nd>@app</span><span class=o>.</span><span class=n>on_event</span><span class=p>(</span><span class=s2>&quot;startup&quot;</span><span class=p>)</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>load_model</span><span class=p>():</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>    <span class=k>global</span> <span class=n>model</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>    <span class=n>model</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;model.pkl&quot;</span><span class=p>)</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=c1># O con dependency injection</span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=kn>from</span><span class=w> </span><span class=nn>functools</span><span class=w> </span><span class=kn>import</span> <span class=n>lru_cache</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=nd>@lru_cache</span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=k>def</span><span class=w> </span><span class=nf>get_model</span><span class=p>():</span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>    <span class=k>return</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;model.pkl&quot;</span><span class=p>)</span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictRequest</span><span class=p>,</span> <span class=n>model</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_model</span><span class=p>)):</span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>    <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</code></pre></div></p> <hr> <h3 id=trampa-3-logs-sin-contexto-de-request>Trampa 3: Logs sin contexto de request<a class=headerlink href=#trampa-3-logs-sin-contexto-de-request title="Permanent link">&para;</a></h3> <p><strong>SÃ­ntoma</strong>: Logs sin forma de correlacionar quÃ© request fallÃ³.</p> <p><strong>SoluciÃ³n</strong>: AÃ±adir request_id con middleware: <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>class</span><span class=w> </span><span class=nc>RequestIDMiddleware</span><span class=p>(</span><span class=n>BaseHTTPMiddleware</span><span class=p>):</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>):</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a>        <span class=n>request_id</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())[:</span><span class=mi>8</span><span class=p>]</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a>        <span class=k>with</span> <span class=n>logger</span><span class=o>.</span><span class=n>contextualize</span><span class=p>(</span><span class=n>request_id</span><span class=o>=</span><span class=n>request_id</span><span class=p>):</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a>            <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&quot;X-Request-ID&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>request_id</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a>        <span class=k>return</span> <span class=n>response</span>
</code></pre></div></p> <hr> <h2 id=quiz-del-modulo-semanas-19-20>ğŸ“ Quiz del MÃ³dulo â€” Semanas 19-20<a class=headerlink href=#quiz-del-modulo-semanas-19-20 title="Permanent link">&para;</a></h2> <h3 id=quiz-semana-19-fastapi>Quiz Semana 19: FastAPI<a class=headerlink href=#quiz-semana-19-fastapi title="Permanent link">&para;</a></h3> <h4 id=pregunta-1-25-pts>Pregunta 1 (25 pts)<a class=headerlink href=#pregunta-1-25-pts title="Permanent link">&para;</a></h4> <p>Â¿Por quÃ© usar Pydantic schemas en lugar de <code>dict</code> para requests?</p> <details> <summary>âœ… Respuesta</summary> 1. **ValidaciÃ³n automÃ¡tica**: Tipos, rangos, formatos 2. **DocumentaciÃ³n**: OpenAPI generada automÃ¡ticamente 3. **Seguridad**: Rechaza payloads malformados antes de llegar al cÃ³digo 4. **Autocompletado**: IDE sabe quÃ© campos existen </details> <h4 id=pregunta-2-25-pts>Pregunta 2 (25 pts)<a class=headerlink href=#pregunta-2-25-pts title="Permanent link">&para;</a></h4> <p>Â¿CÃ³mo evitas cargar el modelo en cada request?</p> <details> <summary>âœ… Respuesta</summary> Usar `@app.on_event("startup")` o `@lru_cache`: <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=nd>@lru_cache</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=k>def</span><span class=w> </span><span class=nf>get_model</span><span class=p>():</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>    <span class=k>return</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;model.pkl&quot;</span><span class=p>)</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>)</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>model</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_model</span><span class=p>)):</span>
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>    <span class=o>...</span>
</code></pre></div> </details> <h4 id=pregunta-3-25-pts>Pregunta 3 (25 pts)<a class=headerlink href=#pregunta-3-25-pts title="Permanent link">&para;</a></h4> <p>Â¿Por quÃ© es importante el endpoint <code>/health</code>?</p> <details> <summary>âœ… Respuesta</summary> 1. **Load balancers**: Verifican si el servicio estÃ¡ vivo 2. **Kubernetes**: Probes de readiness/liveness 3. **Monitoring**: Alertas si el servicio no responde 4. **Debugging**: Verificar conectividad bÃ¡sica </details> <h4 id=ejercicio-practico-25-pts>ğŸ”§ Ejercicio PrÃ¡ctico (25 pts)<a class=headerlink href=#ejercicio-practico-25-pts title="Permanent link">&para;</a></h4> <p>Crea un endpoint <code>/predict</code> con schema de entrada validado (age 18-100, balance â‰¥0) y respuesta estructurada (prediction, probability, risk_level).</p> <details> <summary>âœ… SoluciÃ³n</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=kn>from</span><span class=w> </span><span class=nn>pydantic</span><span class=w> </span><span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=kn>from</span><span class=w> </span><span class=nn>fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPI</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=k>class</span><span class=w> </span><span class=nc>PredictRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a>    <span class=n>balance</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=k>class</span><span class=w> </span><span class=nc>PredictResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>    <span class=n>prediction</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>    <span class=n>probability</span><span class=p>:</span> <span class=nb>float</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a>    <span class=n>risk_level</span><span class=p>:</span> <span class=nb>str</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=nd>@app</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&quot;/predict&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictResponse</span><span class=p>)</span>
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=k>def</span><span class=w> </span><span class=nf>predict</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>PredictRequest</span><span class=p>):</span>
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>    <span class=n>features</span> <span class=o>=</span> <span class=p>[[</span><span class=n>request</span><span class=o>.</span><span class=n>age</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>balance</span><span class=p>]]</span>
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>    <span class=n>pred</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>features</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a>    <span class=n>prob</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict_proba</span><span class=p>(</span><span class=n>features</span><span class=p>)[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a>    <span class=n>risk</span> <span class=o>=</span> <span class=s2>&quot;high&quot;</span> <span class=k>if</span> <span class=n>prob</span> <span class=o>&gt;</span> <span class=mf>0.7</span> <span class=k>else</span> <span class=s2>&quot;medium&quot;</span> <span class=k>if</span> <span class=n>prob</span> <span class=o>&gt;</span> <span class=mf>0.3</span> <span class=k>else</span> <span class=s2>&quot;low&quot;</span>
<a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a>    <span class=k>return</span> <span class=n>PredictResponse</span><span class=p>(</span><span class=n>prediction</span><span class=o>=</span><span class=n>pred</span><span class=p>,</span> <span class=n>probability</span><span class=o>=</span><span class=n>prob</span><span class=p>,</span> <span class=n>risk_level</span><span class=o>=</span><span class=n>risk</span><span class=p>)</span>
</code></pre></div> </details> <hr> <div align=center> **Siguiente mÃ³dulo** â†’ [15. Streamlit](15_STREAMLIT.md) --- [â† Volver al Ãndice](00_INDICE.md) </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Volver al principio </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 DuqueOM â€” GuÃ­a MLOps v2 </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/DuqueOM target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/duqueom target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>